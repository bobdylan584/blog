
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../img/logo.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.0.1">
    
    
      
        <title>2.3 Faster-RCNN网络 - 计算机视觉基础CV</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.816931ca.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.9204c3b2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>function __md_scope(e,t,_){return new URL(_||(t===localStorage?"../..":"../.."),location).pathname+"."+e}function __md_get(e,t=localStorage,_){return JSON.parse(t.getItem(__md_scope(e,t,_)))}function __md_set(e,t,_=localStorage,o){try{_.setItem(__md_scope(e,_,o),JSON.stringify(t))}catch(e){}}</script>
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#23-faster-rcnn" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="计算机视觉基础CV" class="md-header__button md-logo" aria-label="计算机视觉基础CV" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            计算机视觉基础CV
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2.3 Faster-RCNN网络
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="计算机视觉基础CV" class="md-nav__button md-logo" aria-label="计算机视觉基础CV" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    计算机视觉基础CV
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        课程介绍
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          第一章 图像分类
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第一章 图像分类" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          第一章 图像分类
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/01-overview/" class="md-nav__link">
        1.1 图像分类简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/02-AlexNet/" class="md-nav__link">
        1.2 AlexNet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/03-VGGNet/" class="md-nav__link">
        1.3 VGG
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/04-GoogLeNet/" class="md-nav__link">
        1.4 GoogLeNet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/05-ResNet/" class="md-nav__link">
        1.5 ResNet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/06-%E5%9B%BE%E5%83%8F%E5%A2%9E%E5%BC%BA/" class="md-nav__link">
        1.6 图像增强
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/07-%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83/" class="md-nav__link">
        1.7 模型微调
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/08-%E6%B1%BD%E8%BD%A6%E8%BD%A6%E5%9E%8B%E5%88%86%E7%B1%BB%E6%A1%88%E4%BE%8B/" class="md-nav__link">
        1.8 汽车车型分类案例
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          第二章 目标检测
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第二章 目标检测" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          第二章 目标检测
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../00-overview/" class="md-nav__link">
        2.1 目标检测概述
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../01-RCNN/" class="md-nav__link">
        2.2 R-CNN网络基础
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          2.3 Faster-RCNN网络
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        2.3 Faster-RCNN网络
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1. 网络工作流程
  </a>
  
    <nav class="md-nav" aria-label="1. 网络工作流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    1.1 数据加载
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    1.2 模型加载
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    1.3 模型预测过程
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2.模型结构详解
  </a>
  
    <nav class="md-nav" aria-label="2.模型结构详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21backbone" class="md-nav__link">
    2.1backbone
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-rpn" class="md-nav__link">
    2.2 RPN网络
  </a>
  
    <nav class="md-nav" aria-label="2.2 RPN网络">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#221-anchors" class="md-nav__link">
    2.2.1 anchors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#222-rpn" class="md-nav__link">
    2.2.2 RPN分类
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#223-rpn" class="md-nav__link">
    2.2.3 RPN回归
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#424-proposal" class="md-nav__link">
    4.2.4 Proposal层
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-roipooling" class="md-nav__link">
    2.3 ROIPooling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24" class="md-nav__link">
    2.4 目标分类与回归
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-fasterrcnn" class="md-nav__link">
    3 FasterRCNN的训练
  </a>
  
    <nav class="md-nav" aria-label="3 FasterRCNN的训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-rpn" class="md-nav__link">
    3.1 RPN网络的训练
  </a>
  
    <nav class="md-nav" aria-label="3.1 RPN网络的训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311" class="md-nav__link">
    3.1.1正负样本标记
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312-rpn" class="md-nav__link">
    3.1.2 RPN网络的损失函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-fastrcnn" class="md-nav__link">
    3.2 FastRCNN网络的训练
  </a>
  
    <nav class="md-nav" aria-label="3.2 FastRCNN网络的训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321" class="md-nav__link">
    3.2.1 正负样本标记
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-fastrcnn" class="md-nav__link">
    3.2.2  FastRCNN的损失函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-fasterrcnn" class="md-nav__link">
    3.3 FasterRCNN的训练
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../03-wheat_detection_fasterRCNN/" class="md-nav__link">
        2.4 麦穗检测案例-FasterRCNN
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../04-yolo/" class="md-nav__link">
        2.5.yolo系列
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../05-yoloV4%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/" class="md-nav__link">
        2.6.yoloV4算法详解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../06-yoloV5%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/" class="md-nav__link">
        2.7.yoloV5算法详解及案例
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1. 网络工作流程
  </a>
  
    <nav class="md-nav" aria-label="1. 网络工作流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    1.1 数据加载
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    1.2 模型加载
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    1.3 模型预测过程
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2.模型结构详解
  </a>
  
    <nav class="md-nav" aria-label="2.模型结构详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21backbone" class="md-nav__link">
    2.1backbone
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-rpn" class="md-nav__link">
    2.2 RPN网络
  </a>
  
    <nav class="md-nav" aria-label="2.2 RPN网络">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#221-anchors" class="md-nav__link">
    2.2.1 anchors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#222-rpn" class="md-nav__link">
    2.2.2 RPN分类
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#223-rpn" class="md-nav__link">
    2.2.3 RPN回归
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#424-proposal" class="md-nav__link">
    4.2.4 Proposal层
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-roipooling" class="md-nav__link">
    2.3 ROIPooling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24" class="md-nav__link">
    2.4 目标分类与回归
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-fasterrcnn" class="md-nav__link">
    3 FasterRCNN的训练
  </a>
  
    <nav class="md-nav" aria-label="3 FasterRCNN的训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-rpn" class="md-nav__link">
    3.1 RPN网络的训练
  </a>
  
    <nav class="md-nav" aria-label="3.1 RPN网络的训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311" class="md-nav__link">
    3.1.1正负样本标记
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312-rpn" class="md-nav__link">
    3.1.2 RPN网络的损失函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-fastrcnn" class="md-nav__link">
    3.2 FastRCNN网络的训练
  </a>
  
    <nav class="md-nav" aria-label="3.2 FastRCNN网络的训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321" class="md-nav__link">
    3.2.1 正负样本标记
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-fastrcnn" class="md-nav__link">
    3.2.2  FastRCNN的损失函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-fasterrcnn" class="md-nav__link">
    3.3 FasterRCNN的训练
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="23-faster-rcnn">2.3 Faster-RCNN网络<a class="headerlink" href="#23-faster-rcnn" title="Permanent link">&para;</a></h1>
<p><strong>学习目标</strong></p>
<ul>
<li>熟悉FasterRCNN目标检测的思想</li>
<li>知道anchor（锚框）的思想</li>
<li>掌握RPN网络是如何进行候选区域的生成的</li>
<li>掌握ROIPooling的使用方法</li>
<li>知道fasterRCNN的训练方法</li>
</ul>
<hr />
<p><img alt="image-20200914143645050" src="../assets/image-20200914143645050.png" /></p>
<p>在R-CNN和Fast RCNN的基础上，在2016年提出了Faster RCNN网络模型，在结构上，Faster RCNN已经将候选区域的生成，特征提取，目标分类及目标框的回归都整合在了一个网络中，综合性能有较大提高，在检测速度方面尤为明显。接下来我们给大家详细介绍fasterRCNN网络模型。网络基本结构如下图所示：</p>
<p><img alt="image-20200914161108604" src="../assets/image-20200914161108604.png" /></p>
<p>Faster RCNN可以看成是区域生成网络(RPN)与Fast RCNN的组合，其中区域生成网络(RPN)替代选择性搜索来生成候选区域，Fast RCNN用来进行目标检测。</p>
<h2 id="1">1. 网络工作流程<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>FasterRCNN的工作流程是：</p>
<p><img alt="image-20201230100055563" src="../assets/image-20201230100055563.png" /></p>
<p>1、<strong>特征提取</strong>：将整个图像缩放至固定的大小输入到CNN网络中进行特征提取，得到特征图。</p>
<p>2、<strong>候选区域提取</strong>：输入特征图，使用区域生成网络RPN，产生一些列的候选区域</p>
<p>3、<strong>ROIPooling</strong>: 与Fast RCNN网络中一样，使用最大池化固定候选区域的尺寸，送入后续网络中进行处理</p>
<p>4、<strong>目标分类和回归</strong>：与Fast RCNN网络中一样，使用两个同级层:K+1个类别的SoftMax分类层和边框的回归层，来完成目标的分类和回归。</p>
<p>Faster R-CNN的流程与Fast R-CNN的区别不是很大，重要的改进是使用RPN网络来替代选择性搜索获取候选区域，所以我们可以将Faster R-CNN网络看做RPN和Fast R-CNN网络的结合。</p>
<p>接下来我们使用torchvison工具包来看下fasterRCNN预训练模型的使用过程。torchvision安装时直接使用：</p>
<div class="highlight"><pre><span></span><code> pip install torchvision
</code></pre></div>
<p>即可，在安装torchvision时，应保证已安装了pytorch。</p>
<p>接下来我们按照以下步骤进行目标检测：</p>
<ul>
<li>获取数据和加载预训练网络</li>
<li>获取网络的目标检测结果</li>
</ul>
<p>该部分代码在fasterRCNN.ipynb中，首先导入相应的工具包:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># pytorh相关的工具包</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
<span class="kn">from</span> <span class="nn">torchvision.io</span> <span class="kn">import</span> <span class="n">read_image</span>
<span class="c1"># 读取图像的工具包</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="c1"># 绘图</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</code></pre></div>
<h3 id="11">1.1 数据加载<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<p>该部分代码在fasterRCNN.ipynb中，加载一张图片送入网络中进行预测：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 获取图片</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;img3.jpg&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</code></pre></div>
<p>图片展示如下：</p>
<p><img alt="image-20220311144049006" src="../assets/image-20220311144049006-6980854.png" /></p>
<p>原始图像的大小</p>
<div class="highlight"><pre><span></span><code><span class="n">img</span><span class="o">.</span><span class="n">size</span>
</code></pre></div>
<p>输出为：</p>
<div class="highlight"><pre><span></span><code>(994, 734)
</code></pre></div>
<p>在将图像送入网络之前，我们对其进行了尺度的调整，类型转换等处理，如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 将图片格式转换为tensor形式，大小转换为800x800的大小</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">800</span><span class="p">,</span><span class="mi">800</span><span class="p">))])</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</code></pre></div>
<p>送入网络中图像的大小为：</p>
<div class="highlight"><pre><span></span><code><span class="n">img</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>
<p>输出为(pytorch中送入网络中的图像的表示形式【C，H，W】)：</p>
<div class="highlight"><pre><span></span><code>torch.Size([3, 800, 800])
</code></pre></div>
<p>我们将其展示出来，如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 进行通道的调整</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>
<p>展示结果为：</p>
<p><img alt="image-20220311144251977" src="../assets/image-20220311144251977-6980973.png" /></p>
<p>图像被我们从原始的(994, 734)转换为800x800的大小，可送入网络中进行预测。</p>
<h3 id="12">1.2 模型加载<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<p>该部分代码在fasterRCNN.ipynb中，加载使用coco数据集预训练的模型，对图像进行预测，CoCo数据预训练的模型可检测90类的目标，如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># coco数据集的class，共90个类别：人，自行车，火车，。。。</span>
<span class="n">coco_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;__background__&#39;</span><span class="p">,</span> <span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="s1">&#39;bicycle&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">,</span> <span class="s1">&#39;motorcycle&#39;</span><span class="p">,</span> <span class="s1">&#39;airplane&#39;</span><span class="p">,</span> <span class="s1">&#39;bus&#39;</span><span class="p">,</span>
    <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;truck&#39;</span><span class="p">,</span> <span class="s1">&#39;boat&#39;</span><span class="p">,</span> <span class="s1">&#39;traffic light&#39;</span><span class="p">,</span> <span class="s1">&#39;fire hydrant&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;stop sign&#39;</span><span class="p">,</span>
    <span class="s1">&#39;parking meter&#39;</span><span class="p">,</span> <span class="s1">&#39;bench&#39;</span><span class="p">,</span> <span class="s1">&#39;bird&#39;</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="s1">&#39;dog&#39;</span><span class="p">,</span> <span class="s1">&#39;horse&#39;</span><span class="p">,</span> <span class="s1">&#39;sheep&#39;</span><span class="p">,</span> <span class="s1">&#39;cow&#39;</span><span class="p">,</span>
    <span class="s1">&#39;elephant&#39;</span><span class="p">,</span> <span class="s1">&#39;bear&#39;</span><span class="p">,</span> <span class="s1">&#39;zebra&#39;</span><span class="p">,</span> <span class="s1">&#39;giraffe&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;backpack&#39;</span><span class="p">,</span> <span class="s1">&#39;umbrella&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
    <span class="s1">&#39;handbag&#39;</span><span class="p">,</span> <span class="s1">&#39;tie&#39;</span><span class="p">,</span> <span class="s1">&#39;suitcase&#39;</span><span class="p">,</span> <span class="s1">&#39;frisbee&#39;</span><span class="p">,</span> <span class="s1">&#39;skis&#39;</span><span class="p">,</span> <span class="s1">&#39;snowboard&#39;</span><span class="p">,</span> <span class="s1">&#39;sports ball&#39;</span><span class="p">,</span>
    <span class="s1">&#39;kite&#39;</span><span class="p">,</span> <span class="s1">&#39;baseball bat&#39;</span><span class="p">,</span> <span class="s1">&#39;baseball glove&#39;</span><span class="p">,</span> <span class="s1">&#39;skateboard&#39;</span><span class="p">,</span> <span class="s1">&#39;surfboard&#39;</span><span class="p">,</span> <span class="s1">&#39;tennis racket&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bottle&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;wine glass&#39;</span><span class="p">,</span> <span class="s1">&#39;cup&#39;</span><span class="p">,</span> <span class="s1">&#39;fork&#39;</span><span class="p">,</span> <span class="s1">&#39;knife&#39;</span><span class="p">,</span> <span class="s1">&#39;spoon&#39;</span><span class="p">,</span> <span class="s1">&#39;bowl&#39;</span><span class="p">,</span>
    <span class="s1">&#39;banana&#39;</span><span class="p">,</span> <span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;sandwich&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;broccoli&#39;</span><span class="p">,</span> <span class="s1">&#39;carrot&#39;</span><span class="p">,</span> <span class="s1">&#39;hot dog&#39;</span><span class="p">,</span> <span class="s1">&#39;pizza&#39;</span><span class="p">,</span>
    <span class="s1">&#39;donut&#39;</span><span class="p">,</span> <span class="s1">&#39;cake&#39;</span><span class="p">,</span> <span class="s1">&#39;chair&#39;</span><span class="p">,</span> <span class="s1">&#39;couch&#39;</span><span class="p">,</span> <span class="s1">&#39;potted plant&#39;</span><span class="p">,</span> <span class="s1">&#39;bed&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;dining table&#39;</span><span class="p">,</span>
    <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;toilet&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;tv&#39;</span><span class="p">,</span> <span class="s1">&#39;laptop&#39;</span><span class="p">,</span> <span class="s1">&#39;mouse&#39;</span><span class="p">,</span> <span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="s1">&#39;keyboard&#39;</span><span class="p">,</span> <span class="s1">&#39;cell phone&#39;</span><span class="p">,</span>
    <span class="s1">&#39;microwave&#39;</span><span class="p">,</span> <span class="s1">&#39;oven&#39;</span><span class="p">,</span> <span class="s1">&#39;toaster&#39;</span><span class="p">,</span> <span class="s1">&#39;sink&#39;</span><span class="p">,</span> <span class="s1">&#39;refrigerator&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;book&#39;</span><span class="p">,</span>
    <span class="s1">&#39;clock&#39;</span><span class="p">,</span> <span class="s1">&#39;vase&#39;</span><span class="p">,</span> <span class="s1">&#39;scissors&#39;</span><span class="p">,</span> <span class="s1">&#39;teddy bear&#39;</span><span class="p">,</span> <span class="s1">&#39;hair drier&#39;</span><span class="p">,</span> <span class="s1">&#39;toothbrush&#39;</span>
<span class="p">]</span>
</code></pre></div>
<p>实例化faster-RCNN模型，并加载预训练好的模型参数：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 实例化模型</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">detection</span><span class="o">.</span><span class="n">fasterrcnn_resnet50_fpn</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>将模型设置为预测模式：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 将模型设置为eval模式</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</code></pre></div>
<p>这时我们可以大致看下模型的结构，为了更清晰的了解fasterRCNN的结构，删除了一些细节信息，如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="n">FasterRCNN</span><span class="p">(</span>
  <span class="p">(</span><span class="n">transform</span><span class="p">):</span> <span class="n">GeneralizedRCNNTransform</span><span class="p">(</span>
      <span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
      <span class="n">Resize</span><span class="p">(</span><span class="n">min_size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,),</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">1333</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
  <span class="p">)</span>
  <span class="p">(</span><span class="n">backbone</span><span class="p">):</span> <span class="n">BackboneWithFPN</span><span class="p">(</span>
    <span class="p">(</span><span class="n">body</span><span class="p">):</span> <span class="n">IntermediateLayerGetter</span><span class="p">(</span>
      <span class="p">(</span><span class="n">conv1</span><span class="p">):</span> <span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      <span class="p">(</span><span class="n">bn1</span><span class="p">):</span> <span class="n">FrozenBatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
      <span class="p">(</span><span class="n">relu</span><span class="p">):</span> <span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="p">(</span><span class="n">maxpool</span><span class="p">):</span> <span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ceil_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      <span class="err">。。。。。</span>
    <span class="p">(</span><span class="n">fpn</span><span class="p">):</span> <span class="n">FeaturePyramidNetwork</span><span class="p">(</span>
      <span class="p">(</span><span class="n">inner_blocks</span><span class="p">):</span> <span class="n">ModuleList</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="n">Conv2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">):</span> <span class="n">Conv2d</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
      <span class="err">。。。。</span>
    <span class="p">)</span>
  <span class="p">)</span>
  <span class="p">(</span><span class="n">rpn</span><span class="p">):</span> <span class="n">RegionProposalNetwork</span><span class="p">(</span>
    <span class="p">(</span><span class="n">anchor_generator</span><span class="p">):</span> <span class="n">AnchorGenerator</span><span class="p">()</span>
    <span class="p">(</span><span class="n">head</span><span class="p">):</span> <span class="n">RPNHead</span><span class="p">(</span>
      <span class="p">(</span><span class="n">conv</span><span class="p">):</span> <span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
      <span class="p">(</span><span class="n">cls_logits</span><span class="p">):</span> <span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
      <span class="p">(</span><span class="n">bbox_pred</span><span class="p">):</span> <span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">)</span>
  <span class="p">)</span>
  <span class="p">(</span><span class="n">roi_heads</span><span class="p">):</span> <span class="n">RoIHeads</span><span class="p">(</span>
    <span class="p">(</span><span class="n">box_roi_pool</span><span class="p">):</span> <span class="n">MultiScaleRoIAlign</span><span class="p">(</span><span class="n">featmap_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">],</span> <span class="n">output_size</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">sampling_ratio</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">(</span><span class="n">box_head</span><span class="p">):</span> <span class="n">TwoMLPHead</span><span class="p">(</span>
      <span class="p">(</span><span class="n">fc6</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">12544</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="p">(</span><span class="n">fc7</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="p">(</span><span class="n">box_predictor</span><span class="p">):</span> <span class="n">FastRCNNPredictor</span><span class="p">(</span>
      <span class="p">(</span><span class="n">cls_score</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">91</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="p">(</span><span class="n">bbox_pred</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">364</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>从这里可以看出，torchvision中的fasterRCNN的主要包含：</p>
<ul>
<li>Transform: 完成数据的标准化处理，并且设置图像的大小最小为800</li>
<li>backbone: 主要包括特征提取的body部分和特征融合fpn网络</li>
<li>rpn: 主要用来生成候选区域</li>
<li>Roi_heads: 返回检测结果</li>
</ul>
<h3 id="13">1.3 模型预测过程<a class="headerlink" href="#13" title="Permanent link">&para;</a></h3>
<p>该部分代码在fasterRCNN.ipynb中，接下来我们将数据送入网络中进行预测：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 直接进行预测</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">([</span><span class="n">img</span><span class="p">])</span>
</code></pre></div>
<p>预测结果中包括网络的检测框，类别信息及每个检测框对应的置信度值，如下所示：</p>
<div class="highlight"><pre><span></span><code>[{&#39;boxes&#39;: tensor([[ 22.1207,  68.7210, 309.7885, 791.1606],
          [359.6369, 110.5316, 558.7224, 780.3055],
          [ 86.0154, 291.1066, 458.9595, 785.5111],
          [516.1552, 217.6513, 767.1631, 745.2240],
          [532.2499, 537.4729, 771.5016, 790.0735],
          [664.4442, 284.9143, 722.0727, 367.2327],
          [ 18.3442, 456.8345, 734.2274, 777.7546]], grad_fn=&lt;StackBackward0&gt;),
  &#39;labels&#39;: tensor([ 1,  1,  1,  1, 62, 64, 15]),
  &#39;scores&#39;: tensor([0.9981, 0.9981, 0.9980, 0.9962, 0.9832, 0.0695, 0.0604],
         grad_fn=&lt;IndexBackward0&gt;)}]
</code></pre></div>
<p>每个检测框对应的类别通过labels进行表示，接下来我们获取每个检测框的类别名称：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 获取类别名称,框及对应的置信度</span>
<span class="n">pred_class</span> <span class="o">=</span> <span class="p">[</span><span class="n">coco_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())]</span> 
<span class="n">pred_boxes</span> <span class="o">=</span> <span class="p">[[(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;boxes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())]</span>  
<span class="n">pred_score</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</code></pre></div>
<p>将框的类别如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="s1">&#39;chair&#39;</span><span class="p">,</span> <span class="s1">&#39;potted plant&#39;</span><span class="p">,</span> <span class="s1">&#39;bench&#39;</span><span class="p">]</span>
</code></pre></div>
<p>对应的概率值为：</p>
<div class="highlight"><pre><span></span><code>[0.9980987,
 0.9980934,
 0.9980253,
 0.99623007,
 0.9832487,
 0.069459654,
 0.060414173]
</code></pre></div>
<p>我们将这些框绘制在图像上：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 图像读取</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;img3.jpg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">800</span><span class="p">,</span><span class="mi">800</span><span class="p">))</span>
<span class="c1"># 图像展示</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># 将框绘制在图像上</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">boxes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">width</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="image-20220309160711931" src="../assets/image-20220309160711931-6981165.png" /></p>
<p>在这些预测框中有些目标的置信度较低，我们进行过滤，设置置信度阈值：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 过滤分数较低的预测</span>
<span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span>
<span class="c1"># 因pred_score是从大大小进行排列的，只要获取最后一个索引即可</span>
<span class="n">pred_t</span> <span class="o">=</span> <span class="p">[</span><span class="n">pred_score</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pred_score</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">pred_boxes</span> <span class="o">=</span> <span class="n">pred_boxes</span><span class="p">[:</span><span class="n">pred_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">pred_class</span> <span class="o">=</span> <span class="n">pred_class</span><span class="p">[:</span><span class="n">pred_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</code></pre></div>
<p>获取过滤后的框及对应的类别结果展示在图像上：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 将过滤后的结构绘制在图像上</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;img3.jpg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">800</span><span class="p">,</span><span class="mi">800</span><span class="p">))</span>
<span class="c1"># 绘制图像</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># 将框绘制在图像上</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">boxes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">width</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>最终的检测结果：</p>
<p><img alt="image-20220309161033268" src="../assets/image-20220309161033268.png" /></p>
<p>上述我们介绍了Faster RCNN的工作流程并且给大家展示了网络的检测结果。那接下来我们解决以下几个问题：</p>
<p>1、网络中的每一部分是怎么构建，怎么完成相应的功能的？</p>
<p>2、怎么训练fastrcnn网络去完成我们自己的任务？</p>
<p>那接下来我们就解决上述问题。</p>
<h2 id="2">2.模型结构详解<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>Faster RCNN的网络结构如下图所示：</p>
<p><img alt="image-20201230141721104" src="../assets/image-20201230141721104.png" /></p>
<p>我们依然将网络分为四部分：</p>
<ul>
<li><strong>Backbone</strong>：Backbone由CNN卷积神经网络构成，常用的是VGG和resnet, 用来提取图像中的特征，获取图像的特征图。该特征图被共享用于后续RPN层生成候选区域和ROIPooling层中。</li>
<li><strong>RPN网络</strong>：RPN网络用于生成候选区域，用于后续的目标检测。</li>
<li><strong>Roi Pooling</strong>: 该部分收集图像的特征图和RPN网络提取的候选区域位置，综合信息后获取固定尺寸的特征，送入后续全连接层判定目标类别和确定目标位置。</li>
<li><strong>目标分类与回归</strong>: 该部分利用ROIpooling输出特征向量计算候选区域的类别，并通过回归获得检测框最终的精确位置。</li>
</ul>
<p>接下来我们就从这四个方面来详细分析fasterRCNN网络的构成，并结合源码理解每一部分实现的功能。</p>
<p>在进行网络处理前，我们先将图像送入transform进行处理：该部分代码在fasterRCNN.ipynb中，</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 送入网络中的数据是【N,C,H,W】</span>
<span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">img</span><span class="p">]</span>
<span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<p>接下来讲images送入网络中进行处理即可。</p>
<h3 id="21backbone">2.1backbone<a class="headerlink" href="#21backbone" title="Permanent link">&para;</a></h3>
<p>backbone一般为VGG，ResNet等网络构成，主要进行特征提取，将最后的全连接层舍弃，得到特征图送入后续网络中进行处理。</p>
<p><img alt="image-20201230142854867" src="../assets/image-20201230142854867.png" /></p>
<p>在源码中使用ResNet + FPN 结构来提取特征。与普通的 FasterRCNN 只需要将一个特征图输入到后续网络中不同，由于加入 FPN结构，需要将多个特征图逐个送入到后续网络中，如下图所示：</p>
<p><img alt="image-20201230143003277" src="../assets/image-20201230143003277.png" /></p>
<p>Resnet进行特征提取，FPN结构作用是当前层的特征图会融合未来层的特征进行上采样，并加以利用。因为有了这样一个结构，当前的特征图就可以获取未来层的信息，也就将低阶特征与高阶特征就有机融合起来了，提升检测精度。如下图所示：</p>
<p><img alt="image-20200917160440015" src="../assets/image-20200917160440015.png" /></p>
<p>在这里ResNet和FPN的完整结构如下图所示:Resnet进行特征提取，FPN网络进行特征融合获取多个特征图后，输入到RPN网络中的特征图是[p2,p3,p4,p5,p6] ，而作为后续目标检测网络FastRCNN的输入则是 [p2,p3,p4,p5] 。</p>
<p><img alt="image-20201020141907780" src="../assets/image-20201020141907780.png" /></p>
<p>我们看下源码实现的内容：</p>
<p>1、resnet特征提取的结果</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 使用backbone获取特征图</span>
<span class="n">features_body</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">body</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">tensors</span><span class="p">)</span>
<span class="n">C2</span><span class="p">,</span><span class="n">C3</span><span class="p">,</span><span class="n">C4</span><span class="p">,</span><span class="n">C5</span> <span class="o">=</span> <span class="n">features_body</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</code></pre></div>
<p>C2,C3,C4,C5是resnet进行特征提取的结果，送入网络中图像大小为（3，800，800），经过特征提取后特征图的大小为：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># C2.size():800/4 </span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
<span class="c1"># C3.size():800/8</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="c1"># C4.size():800/16</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>
<span class="c1"># C5.size():800/32</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">])</span>
</code></pre></div>
<p>2、FPN特征融合的结果</p>
<div class="highlight"><pre><span></span><code><span class="c1"># FPN网络融合：C2,C3,C4,C5是resnet提取的特征结果</span>
<span class="n">features_fpn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">fpn</span><span class="p">(</span><span class="n">features_body</span><span class="p">)</span>
<span class="n">P2</span><span class="p">,</span><span class="n">P3</span><span class="p">,</span><span class="n">P4</span><span class="p">,</span><span class="n">P5</span><span class="p">,</span><span class="n">P6</span> <span class="o">=</span> <span class="n">features_fpn</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</code></pre></div>
<p>P2,P3,P4,P5,P6是特征融合之后的结果，送入后续网络中，其特征图的大小：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># P2.size():800/4 </span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
<span class="c1"># P3.size():800/8</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="c1"># P4.size():800/16</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>
<span class="c1"># P5.size():800/32</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">])</span>
<span class="c1"># P6.size():800/64</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">])</span>
</code></pre></div>
<p>那网络的整体架构表示成：</p>
<p><img alt="image-20201020144728158" src="../assets/image-20201020144728158.png" /></p>
<h3 id="22-rpn">2.2 RPN网络<a class="headerlink" href="#22-rpn" title="Permanent link">&para;</a></h3>
<p>经典的检测方法生成检测框都非常耗时，如overfeat中使用滑动窗口生成检测框；或如R-CNN使用选择性搜索方法生成检测框。而Faster RCNN则抛弃了传统的滑动窗口和选择性搜索的方法，直接使用RPN生成候选区域，能极大提升检测速度。</p>
<p><img alt="image-20200914165619471" src="../assets/image-20200914165619471.png" /></p>
<p>RPN网络的主要流程是：</p>
<p>1、生成一系列的固定参考框anchors,覆盖图像的任意位置，然后送入后续网络中进行分类和回归</p>
<p>2、分类分支：通过softmax分类判断anchor中是否包含目标</p>
<p>3、回归分支：计算目标框对于anchors的偏移量，以获得精确的候选区域</p>
<p>4、最后的Proposal层则负责综合含有目标的anchors和对应bbox回归偏移量获取候选区域，同时剔除太小和超出边界的候选区域。</p>
<h4 id="221-anchors">2.2.1 anchors<a class="headerlink" href="#221-anchors" title="Permanent link">&para;</a></h4>
<p>anchor在目标检测中表示 固定的参考框 ，首先预设一组不同尺度不同长宽比的固定参考框，覆盖几乎所有位置， 每个参考框负责检测与其交并比大于阈值 (训练预设值，常用0.5或0.7) 的目标 ，anchor技术将候选区域生成问题转换为 "这个固定参考框中有没有目标，目标框偏离参考框多远" ，不再需要多尺度遍历滑窗，真正实现了又好又快。</p>
<p>在FastRCNN中框出多尺度、多种长宽比的anchors,如下图所示：下图中分别是尺度为32，64，128，长宽比为1：1，1:2，2：1的一组anchors,我们利用这组anchor在特征图上进行滑动，并对应到原图上即可获取一系列的固定参考框。</p>
<p><img alt="image-20201230161949225" src="../assets/image-20201230161949225.png" /></p>
<p>由于有 FPN 网络，所以会在多个不同尺度特征图中生成anchor，假设某一个特征图大小为hxw，首先会计算这个特征相对于输入图像的下采样倍数 stride：</p>
<p><img alt="image-20200917181250070" src="../assets/image-20200917181250070.png" /></p>
<p>如下图所示：</p>
<p><img alt="image-20200917181349548" src="../assets/image-20200917181349548.png" /></p>
<p>每一个尺度特征图上生成不同比列的anchor:</p>
<p><img alt="image-20201230162534596" src="../assets/image-20201230162534596.png" /></p>
<p>得到一系列的anchors后就可送入后续网络中进行分类和回归。</p>
<p>该部分代码在fasterRCNN.ipynb中，在源码中我们可生成一幅图像对应的anchors: </p>
<div class="highlight"><pre><span></span><code><span class="c1"># 生成anchors,送入图片信息及相应的特征图</span>
<span class="n">anchors</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">rpn</span><span class="o">.</span><span class="n">anchor_generator</span><span class="p">(</span><span class="n">images</span><span class="p">,[</span><span class="n">P2</span><span class="p">,</span><span class="n">P3</span><span class="p">,</span><span class="n">P4</span><span class="p">,</span><span class="n">P5</span><span class="p">,</span><span class="n">P6</span><span class="p">])</span>
</code></pre></div>
<p>对于800x800的图像生成的anchor的数量为：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># anchors[0].size()：</span>
<span class="c1">#200*200*3+100*100*3+50*50*3+25*25*3+13*13*3=159882</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">159882</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</code></pre></div>
<p>anchor的取值为：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">tensor</span><span class="p">([[</span> <span class="o">-</span><span class="mf">23.</span><span class="p">,</span>  <span class="o">-</span><span class="mf">11.</span><span class="p">,</span>   <span class="mf">23.</span><span class="p">,</span>   <span class="mf">11.</span><span class="p">],</span>
         <span class="p">[</span> <span class="o">-</span><span class="mf">16.</span><span class="p">,</span>  <span class="o">-</span><span class="mf">16.</span><span class="p">,</span>   <span class="mf">16.</span><span class="p">,</span>   <span class="mf">16.</span><span class="p">],</span>
         <span class="p">[</span> <span class="o">-</span><span class="mf">11.</span><span class="p">,</span>  <span class="o">-</span><span class="mf">23.</span><span class="p">,</span>   <span class="mf">11.</span><span class="p">,</span>   <span class="mf">23.</span><span class="p">],</span>
         <span class="o">...</span><span class="p">,</span>
         <span class="p">[</span> <span class="mf">370.</span><span class="p">,</span>  <span class="mf">551.</span><span class="p">,</span> <span class="mf">1094.</span><span class="p">,</span>  <span class="mf">913.</span><span class="p">],</span>
         <span class="p">[</span> <span class="mf">476.</span><span class="p">,</span>  <span class="mf">476.</span><span class="p">,</span>  <span class="mf">988.</span><span class="p">,</span>  <span class="mf">988.</span><span class="p">],</span>
         <span class="p">[</span> <span class="mf">551.</span><span class="p">,</span>  <span class="mf">370.</span><span class="p">,</span>  <span class="mf">913.</span><span class="p">,</span> <span class="mf">1094.</span><span class="p">]])]</span>
</code></pre></div>
<p>我们将前1000个anchor绘制在图像上：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 将生成的anchor绘制在图像上</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;img3.jpg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">800</span><span class="p">,</span><span class="mi">800</span><span class="p">))</span>
<span class="c1"># 绘制图像</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># 将框绘制在图像上</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">boxes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span><span class="mi">1000</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">width</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="image-20220309165620482" src="../assets/image-20220309165620482.png" /></p>
<h4 id="222-rpn">2.2.2 RPN分类<a class="headerlink" href="#222-rpn" title="Permanent link">&para;</a></h4>
<p>一副MxN大小的矩阵送入Faster RCNN网络后，经过backbone特征提取到RPN网络变为HxW大小的特征图。如下图所示，是RPN进行分类的网络结构：(k=9)</p>
<p><img alt="image-20200914170316205" src="../assets/image-20200914170316205.png" /></p>
<p>先做一个1x1的卷积，得到[batchsize,H,W,18]的特征图，然后进行变形,将特征图转换为[batchsize,9xH,W,2]的特征图后，送入softmax中进行分类，得到分类结果后，再进行reshape最终得到[batchsize,H,W,18]大小的结果,18表示k=9个anchor是否包含目标的概率值。</p>
<p><img alt="image-20200914170637421" src="../assets/image-20200914170637421.png" /></p>
<h4 id="223-rpn">2.2.3 RPN回归<a class="headerlink" href="#223-rpn" title="Permanent link">&para;</a></h4>
<p>RPN回归的结构如下图所示：(k=9)</p>
<p><img alt="image-20200914173518689" src="../assets/image-20200914173518689.png" /></p>
<p>经过该卷积输出特征图为为[1,  H, W,4x9]，这里相当于feature maps每个点都有9个anchors，每个anchors又都有4个用于回归的:</p>
<p><img alt="image-20200914173617857" src="../assets/image-20200914173617857.png" /></p>
<p>变换量。</p>
<p>该变换量预测的是anchor与真实值之间的平移量和尺度因子：</p>
<p><img alt="image-20200914174033826" src="../assets/image-20200914174033826.png" /></p>
<p>该部分代码在fasterRCNN.ipynb中，利用源码我们可以获得对anchors的分类和回归结果，我们以P2特征图为例：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># RPN网络预测分类，返回：logits送入softmax之前的分数</span>
<span class="n">cls_logits</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rpn</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">cls_logits</span><span class="p">(</span><span class="n">P2</span><span class="p">)</span>
<span class="c1"># RPN网络预测目标框</span>
<span class="n">box_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rpn</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">bbox_pred</span><span class="p">(</span><span class="n">P2</span><span class="p">)</span>
</code></pre></div>
<p>结果分析,P2特征图中一共有3x200x200个anchor，输出他们的分类和回归结果</p>
<div class="highlight"><pre><span></span><code><span class="c1"># cls_logits.size(),每一个anchor都进行了分类分析</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
<span class="c1"># box_pred.size() ：回归结果</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
</code></pre></div>
<p>其中 cls_logits的取值为：</p>
<div class="highlight"><pre><span></span><code>tensor([[[[-4.9525, -8.6189, -7.9043,  ..., -7.1153, -7.0152, -6.2087],
          [-3.9093, -8.1554, -7.6761,  ..., -5.7457, -5.2442, -5.4824],
          [-2.8913, -6.4549, -6.1540,  ..., -3.6381, -3.2611, -3.8778],
          ...,
          [-4.0144, -7.9331, -7.2612,  ..., -5.9252, -6.3376, -6.1646],
          [-4.7249, -9.1262, -8.5185,  ..., -7.1996, -7.6481, -7.1453],
          [-2.5904, -5.4544, -5.0440,  ..., -4.0076, -4.2866, -4.3868]],

         [[-1.2397, -1.9357, -1.6008,  ..., -2.5823, -2.3880, -2.2150],
          [-0.0788, -0.5536, -0.3117,  ..., -0.7293, -0.6024, -1.2866],
          [ 0.2404, -0.4894, -0.1548,  ...,  0.3993,  0.3727, -0.5295],
          ...,
          [-0.8921, -1.7715, -1.1690,  ..., -1.7273, -1.9882, -2.0136],
          [-1.0738, -1.9363, -1.4287,  ..., -2.0681, -2.2555, -2.2789],
          [-0.4302, -0.6752, -0.3291,  ..., -0.6979, -0.8793, -1.3372]],

         [[-3.6792, -2.3455, -1.6957,  ..., -1.8304, -2.2407, -1.3634],
          [-2.5546, -0.3214,  0.2112,  ...,  0.8942,  0.7678,  1.4243],
          [-2.0823, -0.4618,  0.0860,  ...,  0.9763,  0.9266,  1.4695],
          ...,
          [-2.1660, -0.7442, -0.1336,  ..., -1.9861, -2.1365, -0.4541],
          [-2.7510, -1.3608, -0.9367,  ..., -2.4219, -2.5253, -0.7463],
          [-0.2392,  1.5965,  1.6274,  ...,  1.0652,  1.1438,  1.5748]]]],
       grad_fn=&lt;MkldnnConvolutionBackward0&gt;)
</code></pre></div>
<h4 id="424-proposal">4.2.4 Proposal层<a class="headerlink" href="#424-proposal" title="Permanent link">&para;</a></h4>
<p>Proposal层负责综合RPN网络对anchors分类和回归的结果，利用回归的结果对包含目标的anchors进行修正，计算出候选区域，送入后续RoI Pooling层中。</p>
<p>Proposal层处理流程如下：</p>
<ol>
<li>利用RPN网络回归的结果<img alt="[公式]" src="https://www.zhihu.com/equation?tex=%5Bd_%7Bx%7D%28A%29%2Cd_%7By%7D%28A%29%2Cd_%7Bw%7D%28A%29%2Cd_%7Bh%7D%28A%29%5D" />对所有的anchors进行修正，得到修正后的检测框</li>
<li>根据RPN网络分类的softmax输出的概率值由大到小对检测框进行排序，提取前6000个结果，即提取修正位置后的检测框</li>
<li>限定超出图像边界的检测框为图像边界，防止后续roi pooling时候选区域超出图像边界。</li>
</ol>
<p><img alt="image-20200914174724293" src="../assets/image-20200914174724293.png" /></p>
<ol>
<li>
<p>对剩余的检测框进行非极大值抑制NMS</p>
</li>
<li>
<p>Proposal层的输出是对应输入网络图像尺度的归一化后的坐标值[x1, y1, x2, y2]。</p>
</li>
</ol>
<p>到此RPN网络的工作就结束了。该部分代码在fasterRCNN.ipynb中，</p>
<div class="highlight"><pre><span></span><code><span class="c1"># RPN网络生成proposal</span>
<span class="n">proposal</span><span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rpn</span><span class="p">(</span><span class="n">images</span><span class="p">,</span><span class="n">features_fpn</span><span class="p">)</span>
</code></pre></div>
<p>一共生成了1000个候选区域：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># proposal[0][0].size()</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</code></pre></div>
<p>结果为：</p>
<div class="highlight"><pre><span></span><code><span class="p">([</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">472.2222</span><span class="p">,</span> <span class="mf">282.6704</span><span class="p">,</span> <span class="mf">625.2900</span><span class="p">,</span> <span class="mf">643.2105</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">480.1299</span><span class="p">,</span> <span class="mf">394.6739</span><span class="p">,</span> <span class="mf">674.9400</span><span class="p">,</span> <span class="mf">728.7283</span><span class="p">],</span>
          <span class="p">[</span> <span class="mf">11.2800</span><span class="p">,</span> <span class="mf">170.9804</span><span class="p">,</span> <span class="mf">361.7238</span><span class="p">,</span> <span class="mf">751.5059</span><span class="p">],</span>
          <span class="o">...</span><span class="p">,</span>
          <span class="p">[</span><span class="mf">574.2663</span><span class="p">,</span> <span class="mf">279.6072</span><span class="p">,</span> <span class="mf">591.0003</span><span class="p">,</span> <span class="mf">294.0474</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">577.7798</span><span class="p">,</span> <span class="mf">278.1065</span><span class="p">,</span> <span class="mf">596.8508</span><span class="p">,</span> <span class="mf">299.1753</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">576.9445</span><span class="p">,</span> <span class="mf">164.8038</span><span class="p">,</span> <span class="mf">674.0577</span><span class="p">,</span> <span class="mf">269.8643</span><span class="p">]])],</span>
 <span class="p">{})</span>
</code></pre></div>
<p>将其绘制在图像上</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 候选区域的绘制</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;img3.jpg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">800</span><span class="p">,</span><span class="mi">800</span><span class="p">))</span>
<span class="c1"># 显示图像</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># 将候选区域显示在图像上</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">boxes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">proposal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">width</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="image-20220309175519789" src="../assets/image-20220309175519789.png" /></p>
<h3 id="23-roipooling">2.3 ROIPooling<a class="headerlink" href="#23-roipooling" title="Permanent link">&para;</a></h3>
<p>RoI Pooling层则负责收集RPN网络生成的候选区域，并将其映射到特征图中并固定维度，送入后续网络中进行分类和回归。</p>
<p><img alt="image-20201021100152187" src="../assets/image-20201021100152187.png" /></p>
<p>RoI Pooling 的作用过程，如下图所示：</p>
<p><img alt="image-20201021101351332" src="../assets/image-20201021101351332.png" /></p>
<p>RoIpooling使用最大池化将任何有效的RoI区域内的特征转换成具有pool_H×pool_W的固定空间范围的小的特征图，其中pool_H和pool_W是超参数，比如设置为7x7, 它们独立于任何特定的RoI,如下图所示：</p>
<p><img alt="image-20201021100421465" src="../assets/image-20201021100421465.png" /></p>
<p>在实现过程中，FPN网络产生了多个尺度特征图，那候选区域要映射到哪个特征图中呢？</p>
<p><img alt="image-20201021101441266" src="../assets/image-20201021101441266.png" /></p>
<p>在这里，不同尺度的ROI使用不同特征层作为ROI pooling层的输入，大尺度ROI就用后面一些的金字塔层，比如P5；小尺度ROI就用前面一点的特征层，比如P3，我们使用下面的公式确定ROI所在的特征层：</p>
<p><img alt="image-20201021102107570" src="../assets/image-20201021102107570.png" /></p>
<p>其中，224是ImageNet的标准输入，k0是基准值，设置为4，w和h是ROI区域的长和宽，假设ROI是112x112的大小，那么k = k0-1 = 4-1 = 3，意味着该ROI应该使用P3的特征层。k值会做取整处理，防止结果不是整数，而且为了保证k值在2-5之间，还会做截断处理。 该部分代码在fasterRCNN.ipynb中，</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ROI Pooling层实现:</span>
<span class="n">pool_region_list</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_roi_pool</span><span class="p">(</span><span class="n">features_fpn</span><span class="p">,</span> <span class="n">proposal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">images</span><span class="o">.</span><span class="n">image_sizes</span><span class="p">)</span>
</code></pre></div>
<p>输出结果为：每一个候选区域都被固定为7x7大小</p>
<div class="highlight"><pre><span></span><code><span class="c1"># pool_region_list.size()</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
</code></pre></div>
<p>具体如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="n">tensor</span><span class="p">([[[[</span><span class="o">-</span><span class="mf">3.0290e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.4801e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.3355e-01</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.7696e-01</span><span class="p">,</span>
            <span class="mf">1.8509e-01</span><span class="p">,</span>  <span class="mf">6.6568e-01</span><span class="p">],</span>
          <span class="p">[</span> <span class="mf">4.8405e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.9127e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2898e+00</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.8544e-01</span><span class="p">,</span>
            <span class="mf">1.6745e-01</span><span class="p">,</span>  <span class="mf">6.4149e-01</span><span class="p">],</span>
          <span class="p">[</span> <span class="mf">2.6655e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.9603e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.8114e-01</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.4995e-01</span><span class="p">,</span>
           <span class="o">-</span><span class="mf">1.2209e-01</span><span class="p">,</span>  <span class="mf">4.2529e-01</span><span class="p">],</span>
          <span class="o">...</span><span class="p">,</span>
          <span class="p">[</span><span class="o">-</span><span class="mf">7.9032e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.3308e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0445e+00</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0004e+00</span><span class="p">,</span>
           <span class="o">-</span><span class="mf">1.4248e+00</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0955e+00</span><span class="p">],</span>
          <span class="p">[</span><span class="o">-</span><span class="mf">2.0235e-01</span><span class="p">,</span>  <span class="mf">1.2646e-01</span><span class="p">,</span>  <span class="mf">3.0089e-01</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.9803e-01</span><span class="p">,</span>
           <span class="o">-</span><span class="mf">1.4375e+00</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3155e+00</span><span class="p">],</span>
          <span class="p">[</span> <span class="mf">4.0225e-01</span><span class="p">,</span>  <span class="mf">2.8825e-01</span><span class="p">,</span>  <span class="mf">3.6015e-01</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span>  <span class="mf">1.7556e-01</span><span class="p">,</span>
           <span class="o">-</span><span class="mf">6.1306e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1433e+00</span><span class="p">]]]],</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">IndexPutBackward0</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div>
<h3 id="24">2.4 目标分类与回归<a class="headerlink" href="#24" title="Permanent link">&para;</a></h3>
<p>该部分利用获得的候选区域的特征图，通过全连接层与softmax计算每个候选区域具体属于的类别（如人，车，电视等），输出概率值；同时再次利用回归方法获得每个候选区域的位置偏移量，用于回归更加精确的目标检测框。该部分网络结构如下所示：</p>
<p><img alt="image-20200914175906233" src="../assets/image-20200914175906233.png" /></p>
<p>从RoI Pooling层获取到固定大小的特征图后，送入后续网络，可以看到做了如下2件事：</p>
<ol>
<li>通过全连接和softmax对候选区域进行分类</li>
<li>再次对候选区域进行回归修正，获取更高精度的检测框</li>
</ol>
<p>实现流程如下：该部分代码在fasterRCNN.ipynb中，</p>
<p>首先获取网络分类和回归的结果：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 模型最终输出的结果</span>
<span class="n">detection</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">proposal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">images</span><span class="o">.</span><span class="n">image_sizes</span><span class="p">)</span>
</code></pre></div>
<p>检测的结果如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="p">([{</span><span class="s1">&#39;boxes&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">([[</span><span class="mf">359.8341</span><span class="p">,</span> <span class="mf">111.3523</span><span class="p">,</span> <span class="mf">558.0009</span><span class="p">,</span> <span class="mf">777.9014</span><span class="p">],</span>
           <span class="p">[</span> <span class="mf">86.5611</span><span class="p">,</span> <span class="mf">290.7203</span><span class="p">,</span> <span class="mf">459.5951</span><span class="p">,</span> <span class="mf">785.2094</span><span class="p">],</span>
           <span class="p">[</span> <span class="mf">22.1627</span><span class="p">,</span>  <span class="mf">70.4335</span><span class="p">,</span> <span class="mf">309.8072</span><span class="p">,</span> <span class="mf">790.7128</span><span class="p">],</span>
           <span class="p">[</span><span class="mf">515.9180</span><span class="p">,</span> <span class="mf">217.7970</span><span class="p">,</span> <span class="mf">766.3583</span><span class="p">,</span> <span class="mf">743.9280</span><span class="p">],</span>
           <span class="p">[</span><span class="mf">531.3500</span><span class="p">,</span> <span class="mf">536.5439</span><span class="p">,</span> <span class="mf">771.5784</span><span class="p">,</span> <span class="mf">790.1054</span><span class="p">],</span>
           <span class="p">[</span><span class="mf">666.4915</span><span class="p">,</span> <span class="mf">284.8808</span><span class="p">,</span> <span class="mf">722.3298</span><span class="p">,</span> <span class="mf">367.1904</span><span class="p">],</span>
           <span class="p">[</span> <span class="mf">19.0011</span><span class="p">,</span> <span class="mf">460.5744</span><span class="p">,</span> <span class="mf">728.2871</span><span class="p">,</span> <span class="mf">777.8762</span><span class="p">]],</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">IndexBackward0</span><span class="o">&gt;</span><span class="p">),</span>
   <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">([</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">15</span><span class="p">]),</span>
   <span class="s1">&#39;scores&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">([</span><span class="mf">0.9982</span><span class="p">,</span> <span class="mf">0.9981</span><span class="p">,</span> <span class="mf">0.9980</span><span class="p">,</span> <span class="mf">0.9958</span><span class="p">,</span> <span class="mf">0.9854</span><span class="p">,</span> <span class="mf">0.1073</span><span class="p">,</span> <span class="mf">0.0618</span><span class="p">],</span>
          <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">IndexBackward0</span><span class="o">&gt;</span><span class="p">)}],</span>
 <span class="p">{})</span>
</code></pre></div>
<p>结果为：一共检测出7个目标，每个目标的目标位置，目标类别id，目标类别置信度等信息构成。</p>
<p>可以将其绘制在图像上：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检测结果的绘制</span>
<span class="n">detection_boxes</span> <span class="o">=</span> <span class="n">detection</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;boxes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;img3.jpg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">800</span><span class="p">,</span><span class="mi">800</span><span class="p">))</span>
<span class="c1"># 显示图像</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># 将检测结果绘制在图像上</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">boxes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">detection_boxes</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">width</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="image-20220309181251702" src="../assets/image-20220309181251702.png" /></p>
<p>到这我们就完成了整个网络的介绍。</p>
<h2 id="3-fasterrcnn">3 FasterRCNN的训练<a class="headerlink" href="#3-fasterrcnn" title="Permanent link">&para;</a></h2>
<p>Faster R-CNN的训练分为两部分，即RPN网络和检测网络fastRCNN的训练：</p>
<p><img alt="image-20200914180529313" src="../assets/image-20200914180529313.png" /></p>
<p>在介绍网络训练时，我们需要有标注好的训练集数据和网络模型，主要内容如下所示：</p>
<p>该部分代码在fasterRCNN.ipynb中，</p>
<ul>
<li>数据集加载</li>
</ul>
<p>在这里我们加载VOC数据集，该数据集中包含标注好的数据：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 数据集记载</span>
<span class="kn">from</span> <span class="nn">voc_data_util</span> <span class="kn">import</span> <span class="n">VocDataset</span><span class="p">,</span><span class="n">VOC_BBOX_LABEL_NAMES</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">VocDataset</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;/Users/mac/Desktop/计算机视觉/VOCdevkit/VOC2007&#39;</span><span class="p">,</span> <span class="n">transforms</span> <span class="o">=</span> <span class="n">VocDataset</span><span class="o">.</span><span class="n">get_transform</span><span class="p">())</span>
</code></pre></div>
<p>在这里我们依然以预测时的图片为例，展示数据的标注信息：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 真实值的绘制</span>
<span class="c1"># 获取图像及对应的标注信息</span>
<span class="n">img</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">141</span><span class="p">]</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># 将标注信息绘制在图像上</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">boxes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                      <span class="n">width</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">height</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
                      <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>展示结果如下图所示：</p>
<p><img alt="image-20220311114128416" src="../assets/image-20220311114128416.png" /></p>
<ul>
<li>模型加载</li>
</ul>
<p>在这里加载模型我们不直接加载预训练模型，而是需要根据VOC数据集的类别个数20对模型进行修正，如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 模型加载</span>
<span class="c1"># N+1包含背景</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="mi">21</span>
<span class="c1"># 模型实例化：不使用预训练模型，修正类别个数，backbone使用预训练结果</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">detection</span><span class="o">.</span><span class="n">fasterrcnn_resnet50_fpn</span><span class="p">(</span>
    <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
    <span class="n">pretrained_backbone</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>模型和数据加载进来我们就可以进行模型训练了。</p>
<h3 id="31-rpn">3.1 RPN网络的训练<a class="headerlink" href="#31-rpn" title="Permanent link">&para;</a></h3>
<p>RPN网络的作用从众多的anchors中提取包含目标的，并且经过回归调整的候选区域。为了训练RPN，给每个anchor分配是否包含目标的标签，也就是正负样本的标记，然后进行训练。</p>
<h4 id="311">3.1.1正负样本标记<a class="headerlink" href="#311" title="Permanent link">&para;</a></h4>
<p>正负样本的设置主要分为3类，如下所示：</p>
<ul>
<li>与真实框ground truth（GT）交并比IOU大于0.7的anchor是正样本，即anchor中包含目标，目标值设为1</li>
<li>与真实框ground truth（GT）交并比IOU小于0.3的anchor是负样本，即anchor中不包含目标，目标值设为-1</li>
<li>其他的anchor舍弃，不参与网络的训练，目标值设为0</li>
</ul>
<p>接下来，我们在代码中看下样本标记的结果：该部分代码在fasterRCNN.ipynb中，</p>
<p>将产生的159882个anchor与目标真实值的计算交并比设置正负样本：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 获取anchor对应的目标值：输入：要设置正负样本的anchors(在前面我们已经生成过)，样本的真实值即标注信息；输出：rpn的分类目标值，RPN的回归目标值</span>
<span class="n">rpn_label_matchs</span><span class="p">,</span><span class="n">rpn_target_deltas</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">rpn</span><span class="o">.</span><span class="n">assign_targets_to_anchors</span><span class="p">(</span><span class="n">anchors</span><span class="p">,[</span><span class="n">targets</span><span class="p">])</span>
</code></pre></div>
<p>所有的anchor都设置了分类的目标值和回归的目标值，一共有159882个Anchor。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># anchor对应的分类目标值：rpn_label_matchs[0].size()</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">159882</span><span class="p">])</span>
<span class="c1"># 每个anchor对应的框的目标值：rpn_target_deltas[0].size()</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">159882</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</code></pre></div>
<p>获取正样本：正样本是包含目标的anchor，其目标值设为1，正样本的个数是29个</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 属于正样本的anchors，与GT交并比较大的anchor,目标值设为1</span>
<span class="n">positive_anchor_ids</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">rpn_label_matchs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="c1"># 正样本的个数：positive_anchor_ids.shape </span>
<span class="p">(</span><span class="mi">15</span><span class="p">,)</span>
<span class="c1"># 将正样本绘制在图像上</span>
<span class="c1"># 绘制anchor的正样本</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># 遍历所有的正样本的anchor，绘制在图像上</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">positive_anchor_ids</span><span class="p">:</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">width</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>我们将这些正样本绘制在图像上：可以看出这些anchor与目标还是非常接近的</p>
<p><img alt="image-20220310174331197" src="../assets/image-20220310174331197.png" /></p>
<p>接下来，我们看下负样本的结果，负样本的目标值是-1，</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 负样本的anchor的id</span>
<span class="n">negitivate_anchor_ids</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">rpn_label_matchs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="c1"># 负样本的个数为：negitivate_anchor_ids.shape</span>
<span class="p">(</span><span class="mi">712</span><span class="p">,)</span>
<span class="c1"># 绘制部分anchor的负样本</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># 遍历所有的正样本的anchor，绘制在图像上</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">negitivate_anchor_ids</span><span class="p">:</span>
    <span class="c1"># 负样本的anchor</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
    <span class="c1"># 取余20为0的负样本进行展示</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                          <span class="n">width</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">height</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                          <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>同样我们也将负样本展示在图像上，从图像可以看出这些负样本的anchor与目标差距还是很大的。</p>
<p><img alt="image-20220311115338767" src="../assets/image-20220311115338767.png" /></p>
<h4 id="312-rpn">3.1.2 RPN网络的损失函数<a class="headerlink" href="#312-rpn" title="Permanent link">&para;</a></h4>
<p>RPN网络的损失函数是：</p>
<p><img alt="image-20200915095837059" src="../assets/image-20200915095837059.png" /></p>
<p>其中</p>
<ul>
<li>
<p><span class="arithmatex"><span class="MathJax_Preview">i</span><script type="math/tex">i</script></span>表示anchor的索引</p>
</li>
<li>
<p><span class="arithmatex"><span class="MathJax_Preview">p_i</span><script type="math/tex">p_i</script></span>是第i个anchor 预测为目标的可能性，<span class="arithmatex"><span class="MathJax_Preview">p_i^{*}</span><script type="math/tex">p_i^{*}</script></span>为ground-truth标签。如果这个anchor是positive的，则ground-truth标签为1，否则为0。（即当第i个anchor与GT间IoU&gt;0.7，认为是该anchor是positive，标签为1；反之IoU&lt;0.3时，认为是该anchor是negative，标签为0）</p>
</li>
<li>
<p><span class="arithmatex"><span class="MathJax_Preview">t_i</span><script type="math/tex">t_i</script></span>表示表示正样本anchor到预测区域bounding box的4个参数化预测结果,<span class="arithmatex"><span class="MathJax_Preview">t_i^{*}</span><script type="math/tex">t_i^{*}</script></span>是这个positive anchor对应的ground-truth box的偏移，如下所示：</p>
</li>
</ul>
<p>预测值：</p>
<p><img alt="image-20200915101257709" src="../assets/image-20200915101257709.png" /></p>
<p>真实值：</p>
<p><img alt="image-20200915101314285" src="../assets/image-20200915101314285.png" /></p>
<p>其中，x，y，w，h表示窗口中心坐标和窗口的宽度和高度，变量x， <span class="arithmatex"><span class="MathJax_Preview">x_a 和x^{*}</span><script type="math/tex">x_a 和x^{*}</script></span> 分别表示预测窗口、anchor窗口和Ground Truth的坐标（y，w，h同理）</p>
<p>回归目标值的实现如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 网络回归的目标值</span>
<span class="n">regression_targets</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rpn</span><span class="o">.</span><span class="n">box_coder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">rpn_target_deltas</span><span class="p">,</span> <span class="n">anchors</span><span class="p">)</span>
</code></pre></div>
<p>结果如下所示：每个anchor都有相应的回归的目标值。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># regression_targets[0].size()</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">159882</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="p">(</span><span class="n">tensor</span><span class="p">([[</span> <span class="mf">3.1478</span><span class="p">,</span> <span class="mf">30.9188</span><span class="p">,</span>  <span class="mf">1.6453</span><span class="p">,</span>  <span class="mf">2.3698</span><span class="p">],</span>
         <span class="p">[</span> <span class="mf">4.5250</span><span class="p">,</span> <span class="mf">21.2567</span><span class="p">,</span>  <span class="mf">2.0082</span><span class="p">,</span>  <span class="mf">1.9951</span><span class="p">],</span>
         <span class="p">[</span> <span class="mf">6.5818</span><span class="p">,</span> <span class="mf">14.7873</span><span class="p">,</span>  <span class="mf">2.3829</span><span class="p">,</span>  <span class="mf">1.6322</span><span class="p">],</span>
         <span class="o">...</span><span class="p">,</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">0.8110</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1431</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1108</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4308</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">1.1469</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1011</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7644</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7775</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">1.6221</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0715</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4177</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1240</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">),)</span>
</code></pre></div>
<p>整个Loss分为两部分：分类和回归的损失</p>
<ul>
<li><span class="arithmatex"><span class="MathJax_Preview">L_{cls}</span><script type="math/tex">L_{cls}</script></span>分类的损失（classification loss），是一个二分类器的softmax loss。</li>
</ul>
<p><img alt="image-20200915100858122" src="../assets/image-20200915100858122.png" /></p>
<ul>
<li><span class="arithmatex"><span class="MathJax_Preview">L_{reg}</span><script type="math/tex">L_{reg}</script></span>是回归损失，为<span class="arithmatex"><span class="MathJax_Preview">smooth(x)</span><script type="math/tex">smooth(x)</script></span>损失,并且只有正样本才参与回归损失计算</li>
</ul>
<p><img alt="image-20200915100839788" src="../assets/image-20200915100839788.png" /></p>
<ul>
<li><span class="arithmatex"><span class="MathJax_Preview">N_{cls}</span><script type="math/tex">N_{cls}</script></span>和<span class="arithmatex"><span class="MathJax_Preview">N_{reg}</span><script type="math/tex">N_{reg}</script></span>分别用来标准化分类损失项<span class="arithmatex"><span class="MathJax_Preview">L_{cls}</span><script type="math/tex">L_{cls}</script></span>和回归损失项<span class="arithmatex"><span class="MathJax_Preview">L_{reg}</span><script type="math/tex">L_{reg}</script></span>，默认用batch size设置<span class="arithmatex"><span class="MathJax_Preview">N_{cls}</span><script type="math/tex">N_{cls}</script></span>，用anchor位置数目~2000初始化<span class="arithmatex"><span class="MathJax_Preview">N_{reg}</span><script type="math/tex">N_{reg}</script></span></li>
<li><span class="arithmatex"><span class="MathJax_Preview">N_{cls}</span><script type="math/tex">N_{cls}</script></span>和<span class="arithmatex"><span class="MathJax_Preview">N_{reg}</span><script type="math/tex">N_{reg}</script></span>相差过大，用参数λ来平衡两者，一般取值为<span class="arithmatex"><span class="MathJax_Preview">N_{reg}</span><script type="math/tex">N_{reg}</script></span>和<span class="arithmatex"><span class="MathJax_Preview">N_{cls}</span><script type="math/tex">N_{cls}</script></span>的比值10即可。</li>
</ul>
<h3 id="32-fastrcnn">3.2 FastRCNN网络的训练<a class="headerlink" href="#32-fastrcnn" title="Permanent link">&para;</a></h3>
<p>使用RPN网络收集到的候选区域和imageNet预训练的卷积网络提取的特征对检测的FastRCNN网络进行训练。</p>
<h4 id="321">3.2.1 正负样本标记<a class="headerlink" href="#321" title="Permanent link">&para;</a></h4>
<p>在FastRCNN网络训练时：</p>
<ul>
<li>首先将与真实框ground truth（GT）交并比IOU大于0.5的候选区域设为正样本，类别的目标值是GT的类别</li>
<li>将与真实框ground truth（GT）交并比IOU小于0.5的候选区域设为负样本，类别的目标值是0</li>
</ul>
<p>接下来我们在代码看下正负样本标记的结果：该部分代码在fasterRCNN.ipynb中，</p>
<p>将proposal层产生的候选区域与目标真实值的计算交并比设置正负样本：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># fastRCNN的正负样本设置</span>
<span class="c1"># 输入：RPN网络生成的候选区域，</span>
<span class="c1"># 输出：参与训练的候选区域proposals及这些候选区域的索引matched_idxs，候选区域分类的目标值labels，回归的目标值regression_targets</span>
<span class="c1"># 从生成的所有的proposal中选择正负样本送入网络中</span>
<span class="n">proposals</span><span class="p">,</span> <span class="n">matched_idxs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">regression_targets</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">select_training_samples</span><span class="p">(</span>
    <span class="n">proposal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">targets</span><span class="p">])</span>
</code></pre></div>
<p>最终获取的候选区域的个数为512，labels中0值对应的背景类别，非零值对应着所属的类别ID</p>
<div class="highlight"><pre><span></span><code><span class="c1"># proposals[0].size()</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">512</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="c1"># regression_targets[0].size()</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">512</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="c1"># labels</span>
<span class="p">[</span><span class="n">tensor</span><span class="p">([</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
         <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
         <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
         <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
         <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">9</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">])]</span>
</code></pre></div>
<p>获取正样本：正样本是负责目标检测的候选区域，其目标值不是0，正样本的个数是64个</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 获取正样本的索引</span>
<span class="n">positive_proposal_ids</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="c1"># positive_proposal_ids.shape</span>
<span class="p">(</span><span class="mi">64</span><span class="p">,)</span>
</code></pre></div>
<p>将这些正样本展示在图像上：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 绘制部分候选区域的负样本</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># 遍历所有的负样本的候选区域，绘制在图像上</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">positive_proposal_ids</span><span class="p">:</span>
    <span class="c1"># 正样本的proposals</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="n">proposals</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
    <span class="c1"># 取余10为0的负样本进行展示</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                          <span class="n">width</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">height</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                          <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>结果如下图所示，可以看出这些框跟真实值是非常接近的</p>
<p><img alt="image-20220311135423607" src="../assets/image-20220311135423607.png" /></p>
<p>同样我们也可以获取负样本（背景），并绘制在图像上：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 负样本对应的ID</span>
<span class="n">negitivate_proposal_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="c1"># negitivate_proposal_ids.shape</span>
<span class="p">(</span><span class="mi">448</span><span class="p">,)</span>
<span class="c1"># 绘制部分候选区域的负样本</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># 遍历所有的负样本的候选区域，绘制在图像上</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">negitivate_proposal_ids</span><span class="p">:</span>
    <span class="c1"># 负样本的proposals</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="n">proposals</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
    <span class="c1"># 取余10为0的负样本进行展示</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                          <span class="n">width</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">height</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                          <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>结果如下图所示：</p>
<p><img alt="image-20220311135907650" src="../assets/image-20220311135907650.png" /></p>
<h4 id="322-fastrcnn">3.2.2  FastRCNN的损失函数<a class="headerlink" href="#322-fastrcnn" title="Permanent link">&para;</a></h4>
<p>FastRCNN的输出由两部分组成：一部分是softmax层进行分类，输出类别有K个类别加上”背景”类，另一部分是回归bounding box regressor。也就是：</p>
<ul>
<li>一部分输出在K+1个类别上的离散概率分布（每个候选区域），<span class="arithmatex"><span class="MathJax_Preview">p=(p0,p1,...,pk)</span><script type="math/tex">p=(p0,p1,...,pk)</script></span>。通常，通过全连接层的K+1个输出上的Softmax来计算p。</li>
<li>另一部分输出对于由K个类别中的每一个检测框回归偏移，<span class="arithmatex"><span class="MathJax_Preview">t^{k}=(t_{x}^{k},t_{y}^{k},t_{w}^{k},t_{h}^{k})</span><script type="math/tex">t^{k}=(t_{x}^{k},t_{y}^{k},t_{w}^{k},t_{h}^{k})</script></span>。其中<span class="arithmatex"><span class="MathJax_Preview">t_k</span><script type="math/tex">t_k</script></span>指定相对于候选框的尺度不变转换和对数空间高度/宽度移位，与在RPN网络中是一样的。</li>
</ul>
<p>每个训练的候选区域用 <strong>分类目标值u和检测框回归目标值v标记</strong> 。背景样本用u=0来表示，对每个标记的候选区域使用多任务损失L以联合训练分类和检测框回归：</p>
<p><img alt="image-20200915111032596" src="../assets/image-20200915111032596.png" /></p>
<p>其中<span class="arithmatex"><span class="MathJax_Preview">L_{cls}(p, u) = -\log p_u</span><script type="math/tex">L_{cls}(p, u) = -\log p_u</script></span>，表示交叉熵损失，第二个损失<span class="arithmatex"><span class="MathJax_Preview">L_{loc}</span><script type="math/tex">L_{loc}</script></span>，是定义目标值和预测检测框的四元组之间的损失使用smoothL1损失计算，同样是只有正样本（非背景）的候选区域才计算回归损失，参数λ设为1。</p>
<h3 id="33-fasterrcnn">3.3 FasterRCNN的训练<a class="headerlink" href="#33-fasterrcnn" title="Permanent link">&para;</a></h3>
<p>前面我们已经介绍了网络模型架构和预测结果，在网络预测前我们需要对网络进行训练，接下来我们就来完成模型训练，模型训练也就是要使用损失函数，进行反向传播，利用优化器进行参数更新，训练的流程是：</p>
<ul>
<li>使用Dataloader加载训练数据</li>
<li>
<p>指定优化器：在这里我们使用加动量的SGD方法</p>
</li>
<li>
<p>设置轮次epoch，遍历每个轮次获取batch数据送入网络中进行预测，计算损失函数，使用反向传播更新参数，完成模型训练</p>
</li>
</ul>
<p>接下来我们按照这个流程完成模型训练。该部分代码在fasterRCNN.ipynb中，</p>
<ul>
<li>使用Dataloader加载训练数据</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">))</span>

<span class="c1"># 获取batch的数据，送入网络中进行训练</span>
<span class="n">train_data_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span>
<span class="p">)</span>
</code></pre></div>
<p>在这里我们将一个batch中的数据展示出来：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 遍历数据，获取第一个batch的数据进行展示</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_data_loader</span><span class="p">):</span>
    <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span>
    <span class="c1"># batch的大小</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;图片个数：&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;目标值：&#39;</span><span class="p">,</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">break</span>
</code></pre></div>
<p>结果为：</p>
<div class="highlight"><pre><span></span><code><span class="n">图片个数</span><span class="err">：</span> <span class="mi">2</span>
<span class="n">目标值</span><span class="err">：</span> <span class="p">({</span><span class="s1">&#39;boxes&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">([[</span><span class="mf">654.4000</span><span class="p">,</span>   <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">798.4000</span><span class="p">,</span> <span class="mf">744.3851</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">481.6000</span><span class="p">,</span>  <span class="mf">79.1444</span><span class="p">,</span> <span class="mf">774.4000</span><span class="p">,</span> <span class="mf">742.2460</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">403.2000</span><span class="p">,</span> <span class="mf">320.8556</span><span class="p">,</span> <span class="mf">619.2000</span><span class="p">,</span> <span class="mf">795.7219</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">160.0000</span><span class="p">,</span> <span class="mf">329.4117</span><span class="p">,</span> <span class="mf">488.0000</span><span class="p">,</span> <span class="mf">793.5829</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">75.2000</span><span class="p">,</span> <span class="mf">348.6631</span><span class="p">,</span> <span class="mf">265.6000</span><span class="p">,</span> <span class="mf">774.3316</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">35.2000</span><span class="p">,</span> <span class="mf">468.4492</span><span class="p">,</span> <span class="mf">102.4000</span><span class="p">,</span> <span class="mf">648.1283</span><span class="p">],</span>
        <span class="p">[</span>  <span class="mf">1.6000</span><span class="p">,</span> <span class="mf">444.9198</span><span class="p">,</span>  <span class="mf">96.0000</span><span class="p">,</span> <span class="mf">750.8021</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]),</span> <span class="s1">&#39;image_id&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">([</span><span class="mi">3172</span><span class="p">]),</span> <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">([</span><span class="mf">31320.</span><span class="p">,</span> <span class="mf">56730.</span><span class="p">,</span> <span class="mf">29970.</span><span class="p">,</span> <span class="mf">44485.</span><span class="p">,</span> <span class="mf">23681.</span><span class="p">,</span>  <span class="mf">3528.</span><span class="p">,</span>  <span class="mf">8437.</span><span class="p">]),</span> <span class="s1">&#39;iscrowd&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])},</span> <span class="p">{</span><span class="s1">&#39;boxes&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">([[</span><span class="mf">432.0000</span><span class="p">,</span> <span class="mf">170.6666</span><span class="p">,</span> <span class="mf">571.2000</span><span class="p">,</span> <span class="mf">206.9334</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">604.8000</span><span class="p">,</span> <span class="mf">142.9333</span><span class="p">,</span> <span class="mf">648.0000</span><span class="p">,</span> <span class="mf">183.4667</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span> <span class="s1">&#39;image_id&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">([</span><span class="mi">1001</span><span class="p">]),</span> <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">([</span><span class="mf">1479.</span><span class="p">,</span>  <span class="mf">513.</span><span class="p">]),</span> <span class="s1">&#39;iscrowd&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])}</span>
</code></pre></div>
<ul>
<li>优化器设置</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 获取所有要进行训练的参数，设置优化器</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">]</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>遍历每个轮次进行模型训练</li>
</ul>
<div class="highlight"><pre><span></span><code> <span class="n">迭代次数</span>
<span class="n">itr</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># 存放训练损失</span>
<span class="n">total_train_loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># 损失值</span>
<span class="n">losses_value</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># 遍历每个轮次进行训练</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="c1"># 训练模式</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">train_loss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># 进度条</span>
    <span class="c1"># 遍历数据，获取图像，目标值和图像id</span>
    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">train_data_loader</span><span class="p">:</span>
        <span class="c1"># 将数据送入网络中进行训练，获取损失值(RPN的损失+FastRCNN的损失),将信息打印出来分析</span>
        <span class="n">loss_dict</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">loss_dict</span><span class="p">)</span>
        <span class="c1"># 将损失求和</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">loss</span> <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">loss_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="c1"># 获取loss值</span>
        <span class="n">losses_value</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">train_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">losses_value</span><span class="p">)</span>
        <span class="c1"># 进行反向传播，更新参数</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="c1"># 日志信息</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch: </span><span class="si">{</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">, Batch: </span><span class="si">{</span><span class="n">itr</span><span class="si">}</span><span class="s2">, Loss: </span><span class="si">{</span><span class="n">losses_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># 迭代次数增1</span>
        <span class="n">itr</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># 获取当前轮次的损失</span>
    <span class="n">epoch_train_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
    <span class="c1"># 轮次损失写入到列表中</span>
    <span class="n">total_train_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_train_loss</span><span class="p">)</span>
</code></pre></div>
<p>结果为：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="s1">&#39;loss_classifier&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">(</span><span class="mf">29.4023</span><span class="p">,</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">NllLossBackward0</span><span class="o">&gt;</span><span class="p">),</span> <span class="s1">&#39;loss_box_reg&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">(</span><span class="mf">2.7863</span><span class="p">,</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">DivBackward0</span><span class="o">&gt;</span><span class="p">),</span> <span class="s1">&#39;loss_objectness&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">(</span><span class="mf">6.2046</span><span class="p">,</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">BinaryCrossEntropyWithLogitsBackward0</span><span class="o">&gt;</span><span class="p">),</span> <span class="s1">&#39;loss_rpn_box_reg&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">(</span><span class="mf">0.8658</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">DivBackward0</span><span class="o">&gt;</span><span class="p">)}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Batch</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">39.25891468526476</span>
<span class="p">{</span><span class="s1">&#39;loss_classifier&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">(</span><span class="mf">60.0640</span><span class="p">,</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">NllLossBackward0</span><span class="o">&gt;</span><span class="p">),</span> <span class="s1">&#39;loss_box_reg&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">(</span><span class="mf">0.72087</span><span class="p">,</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">DivBackward0</span><span class="o">&gt;</span><span class="p">),</span> <span class="s1">&#39;loss_objectness&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">(</span><span class="mf">0.22394</span><span class="p">,</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">BinaryCrossEntropyWithLogitsBackward0</span><span class="o">&gt;</span><span class="p">),</span> <span class="s1">&#39;loss_rpn_box_reg&#39;</span><span class="p">:</span> <span class="n">tensor</span><span class="p">(</span><span class="mf">0.291624814647</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">DivBackward0</span><span class="o">&gt;</span><span class="p">)}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Batch</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">61.38612275054647</span>
<span class="err">。。。。。。</span>
</code></pre></div>
<p>损失函数的结果中包含：rpn的损失（loss_objectness，loss_rpn_box_reg）和fastRCNN的损失（loss_classifier，loss_box_reg），将他们加在一起就可得到整个模型的损失进行反向传播。</p>
<p>我们多训练几个轮次，损失函数的变换曲线如下图所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 绘制损失函数变化的曲线</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">total_train_loss</span><span class="p">)),[</span><span class="n">loss</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">total_train_loss</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</code></pre></div>
<p><img alt="image-20200921164738442" src="../assets/image-20200921164738442.png" /></p>
<p>当我们训练好模型后，就可以使用训练好的模型进行预测了，也就是本节开头给大家介绍的内容。</p>
<hr />
<p><strong>总结</strong></p>
<ul>
<li>熟悉FasterRCNN目标检测的思想</li>
</ul>
<p>利用CNN网络进行特征提取，利用RPN生成候选区域，最后进行分类和回归</p>
<ul>
<li>知道anchor的思想</li>
</ul>
<p>anchor技术将检测问题转换为**"这个固定参考框中有没有目标，目标框偏离参考框多远"**，不再需要多尺度遍历滑窗</p>
<ul>
<li>掌握RPN网络是如何进行候选区域的生成的</li>
</ul>
<p>通过softmax判断anchors属于positive或者negative，再利用bounding box regression修正anchors获得精确的proposals</p>
<ul>
<li>掌握ROIPooling的使用方法</li>
</ul>
<p>RoIpooling使用最大池化将任何有效的RoI区域内的特征转换成具有H×W的固定空间范围的小feature map</p>
<ul>
<li>知道fasterRCNN的训练方法</li>
</ul>
<p>正负样本设置的方法，损失函数的定义，端到端的网络训练</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="../01-RCNN/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 2.2 R-CNN网络基础" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              2.2 R-CNN网络基础
            </div>
          </div>
        </a>
      
      
        
        <a href="../03-wheat_detection_fasterRCNN/" class="md-footer__link md-footer__link--next" aria-label="下一页: 2.4 麦穗检测案例-FasterRCNN" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              2.4 麦穗检测案例-FasterRCNN
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "search": "../../assets/javascripts/workers/search.01824240.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.a87c2adc.min.js"></script>
      
        <script src="../../js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>