
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../img/logo.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.0.1">
    
    
      
        <title>2.4 麦穗检测案例-FasterRCNN - 计算机视觉基础CV</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.816931ca.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.9204c3b2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>function __md_scope(e,t,_){return new URL(_||(t===localStorage?"../..":"../.."),location).pathname+"."+e}function __md_get(e,t=localStorage,_){return JSON.parse(t.getItem(__md_scope(e,t,_)))}function __md_set(e,t,_=localStorage,o){try{_.setItem(__md_scope(e,_,o),JSON.stringify(t))}catch(e){}}</script>
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#24-fasterrcnn" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="计算机视觉基础CV" class="md-header__button md-logo" aria-label="计算机视觉基础CV" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            计算机视觉基础CV
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2.4 麦穗检测案例-FasterRCNN
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="计算机视觉基础CV" class="md-nav__button md-logo" aria-label="计算机视觉基础CV" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    计算机视觉基础CV
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        课程介绍
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          第一章 图像分类
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第一章 图像分类" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          第一章 图像分类
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/01-overview/" class="md-nav__link">
        1.1 图像分类简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/02-AlexNet/" class="md-nav__link">
        1.2 AlexNet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/03-VGGNet/" class="md-nav__link">
        1.3 VGG
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/04-GoogLeNet/" class="md-nav__link">
        1.4 GoogLeNet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/05-ResNet/" class="md-nav__link">
        1.5 ResNet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/06-%E5%9B%BE%E5%83%8F%E5%A2%9E%E5%BC%BA/" class="md-nav__link">
        1.6 图像增强
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/07-%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83/" class="md-nav__link">
        1.7 模型微调
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../01-%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB/08-%E6%B1%BD%E8%BD%A6%E8%BD%A6%E5%9E%8B%E5%88%86%E7%B1%BB%E6%A1%88%E4%BE%8B/" class="md-nav__link">
        1.8 汽车车型分类案例
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          第二章 目标检测
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第二章 目标检测" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          第二章 目标检测
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../00-overview/" class="md-nav__link">
        2.1 目标检测概述
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../01-RCNN/" class="md-nav__link">
        2.2 R-CNN网络基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../02-Faster-RCNN/" class="md-nav__link">
        2.3 Faster-RCNN网络
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          2.4 麦穗检测案例-FasterRCNN
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        2.4 麦穗检测案例-FasterRCNN
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1. 麦穗检测项目简介
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2. 麦穗数据集介绍与数据分析
  </a>
  
    <nav class="md-nav" aria-label="2. 麦穗数据集介绍与数据分析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    2.1 数据读取
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    2.2 数据分析
  </a>
  
    <nav class="md-nav" aria-label="2.2 数据分析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#221" class="md-nav__link">
    2.2.1 数据量的分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#222" class="md-nav__link">
    2.2.2 数据分布的分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#223" class="md-nav__link">
    2.2.3 数据展示
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3dataset" class="md-nav__link">
    3.数据加载DataSet的构建
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4.模型训练
  </a>
  
    <nav class="md-nav" aria-label="4.模型训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    4.1 模型构建
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    4.2 训练参数设置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43" class="md-nav__link">
    4.3 数据加载
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44" class="md-nav__link">
    4.4 模型训练
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45" class="md-nav__link">
    4.5 模型保存
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5.模型测试
  </a>
  
    <nav class="md-nav" aria-label="5.模型测试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    5.1 数据和模型加载
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    5.2 模型预测
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../04-yolo/" class="md-nav__link">
        2.5.yolo系列
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../05-yoloV4%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/" class="md-nav__link">
        2.6.yoloV4算法详解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../06-yoloV5%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/" class="md-nav__link">
        2.7.yoloV5算法详解及案例
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1. 麦穗检测项目简介
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2. 麦穗数据集介绍与数据分析
  </a>
  
    <nav class="md-nav" aria-label="2. 麦穗数据集介绍与数据分析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    2.1 数据读取
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    2.2 数据分析
  </a>
  
    <nav class="md-nav" aria-label="2.2 数据分析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#221" class="md-nav__link">
    2.2.1 数据量的分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#222" class="md-nav__link">
    2.2.2 数据分布的分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#223" class="md-nav__link">
    2.2.3 数据展示
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3dataset" class="md-nav__link">
    3.数据加载DataSet的构建
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4.模型训练
  </a>
  
    <nav class="md-nav" aria-label="4.模型训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    4.1 模型构建
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    4.2 训练参数设置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43" class="md-nav__link">
    4.3 数据加载
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44" class="md-nav__link">
    4.4 模型训练
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45" class="md-nav__link">
    4.5 模型保存
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5.模型测试
  </a>
  
    <nav class="md-nav" aria-label="5.模型测试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    5.1 数据和模型加载
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    5.2 模型预测
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="24-fasterrcnn">2.4 麦穗检测案例-FasterRCNN<a class="headerlink" href="#24-fasterrcnn" title="Permanent link">&para;</a></h1>
<p><strong>学习目标</strong></p>
<ul>
<li>了解麦穗检测的数据集的构成</li>
<li>理解项目解决的全流程</li>
<li>能够利用fasterRCNN网络模型进行训练和预测</li>
</ul>
<hr />
<p><img alt="image-20220304145628975" src="../assets/image-20220304145628975.png" /></p>
<h2 id="1">1. 麦穗检测项目简介<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>小麦是我国最重要的粮食作物之一，其不仅关乎着人们日常的饮食需求，同时影响着国民经济的发展和社会稳定。随着智能技术的不断发展，智慧农业对粮食的生产起着重要的作用，一些智能技术对传统农业起到重大的推动作用。</p>
<p>麦穗识别在智慧农业中有较高的应用价值，如粮食产量估计、种子筛选、和种子基因性能等。许多研究人员主要关注智慧农业和麦穗计数。传统麦穗计数主要依靠人工视觉进行主观辨别和判断。该方法具有简单、方便等特点，但需要大量的人力物力效率低下、人的主观因素较多。随着图像识别技术的发展，人们借助智能算法替代传统的计数方法。在对麦穗图像进行精准检测时会遇到视觉上的挑战，如小麦植株重叠，风动下的模糊图像。这些问题加剧了识别单个小麦头的难度。为了克服这些干扰的因素，将计算机技术与农业深度融合，结合图像处理基本技巧，利用深度学习中的神经网络设计一套基于Faster R-CNN的麦穗图像识别算法，用其对大田下小麦的数量、密度、大小等参数预估。小麦管理决策者可运用这些数据进行小麦生产过程的智能决策和精确管理，为小麦的智能识别监控系统提供理论依据和技术支持。</p>
<h2 id="2">2. 麦穗数据集介绍与数据分析<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>小麦图像数据集来自Global Wheat Head detection (GWHD) dataset，其是第一个从现场光学图像进行小麦头检测的大型数据集，包括多个地区的不同品种，涵盖了由欧洲(法国，英国，瑞士)，亚洲(中国，日本)，大洋洲(澳大利亚)和北美(加拿大)的标注图像。所有图像的通用格式为1024 × 1024 px，分辨率为每像素0.1~0.3 mm。本文研究的是不同品种小麦头的密度和大小，部分图像如下图所示：</p>
<p><img alt="image-20220304164817589" src="../assets/image-20220304164817589.png" /></p>
<p>这些数据存放在wheatData文件夹中，其中包括训练集和测试集数据，以及相应的标注信息，如下图所示：</p>
<p><img alt="image-20220304165137150" src="../assets/image-20220304165137150.png" /></p>
<h3 id="21">2.1 数据读取<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<p>首先我们使用pandas读取train_data.csv文件，该部分代码在文件：fasterRCNN_code/dataset_utils.py中。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 数据获取与分析:指定训练集和验证集的路径</span>
<span class="n">train_data_dir</span> <span class="o">=</span> <span class="s1">&#39;wheatData/train&#39;</span>
<span class="n">test_data_dir</span> <span class="o">=</span> <span class="s1">&#39;wheatData/test&#39;</span>
<span class="c1"># 读取CSV文件</span>
<span class="n">train_data_label</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;wheatData/train_data.csv&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_data_label</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</code></pre></div>
<p>结果为：</p>
<p><img alt="image-20220304170538191" src="../assets/image-20220304170538191.png" /></p>
<p>其中每一行表示图像中的一个标注框如下图白色方框所示：</p>
<p><img alt="image-20220304170820961" src="../assets/image-20220304170820961.png" /></p>
<p>主要内容包括：</p>
<ul>
<li>image_id：图像文件的名称，指当前标注框所在的图像</li>
<li>width和height: 图像的宽高，在当前数据集中，所有图片的大小均为1024x1024</li>
<li>x和y: 表示当前标注框的左上角坐标</li>
<li>w和h: 表示标注框的宽和高。</li>
</ul>
<p>对应的图片数据都存放在train文件夹中，test中的图片是测试图像，未进行标注</p>
<h3 id="22">2.2 数据分析<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<h4 id="221">2.2.1 数据量的分析<a class="headerlink" href="#221" title="Permanent link">&para;</a></h4>
<p>该部分代码在文件：fasterRCNN_code/dataset_utils.py中。</p>
<ul>
<li>标注框的数量</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 训练数据大小（这里指的是目标框）</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;目标框个数：</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_data_label</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
</code></pre></div>
<p>结果为：</p>
<div class="highlight"><pre><span></span><code><span class="n">目标框个数</span><span class="err">：</span><span class="p">(</span><span class="mi">147793</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</code></pre></div>
<p>训练集中一共标注了147793个目标框</p>
<ul>
<li>训练集图片的数量</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 有标注信息图片的数量</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;图片数量：</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_data_label</span><span class="p">[</span><span class="s1">&#39;image_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()))</span>
    <span class="c1"># 所有图片的数量</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;所有图片数量：</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_data_dir</span><span class="p">))))</span>
</code></pre></div>
<p>结果为：</p>
<div class="highlight"><pre><span></span><code><span class="n">图片数量</span><span class="err">：</span><span class="mi">3373</span>
<span class="n">所有图片数量</span><span class="err">：</span><span class="mi">3422</span>
</code></pre></div>
<p>说明有 <code>3422-3373=49</code> 张图片没有标注，所以后面进行模型训练时我们只能选择标注信息的图片进行训练。</p>
<h4 id="222">2.2.2 数据分布的分析<a class="headerlink" href="#222" title="Permanent link">&para;</a></h4>
<p>该部分代码在文件：fasterRCNN_code/dataset_utils.py中。</p>
<ul>
<li>图片中目标框数量分布</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">counts</span> <span class="o">=</span> <span class="n">train_data_label</span><span class="p">[</span><span class="s1">&#39;image_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;单张图片中标注框的最大值</span><span class="si">{}</span><span class="s2">和最小值</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">counts</span><span class="p">)))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;boxes&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>结果为：</p>
<div class="highlight"><pre><span></span><code><span class="n">单张图片中标注框的最大值116和最小值1</span>
</code></pre></div>
<p><img alt="image-20220304172655473" src="../assets/image-20220304172655473.png" /></p>
<p>从上图中我们可以看出每张图片中的标注框个数在20-80之间，如果在检测时与该范围相差较大则需要进行核查是否出现问题。</p>
<ul>
<li>标注框位置左上角坐标的分布 </li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 标注框左上角坐标的分布</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">train_data_label</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">pmax</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>结果如下图所示：</p>
<p><img alt="image-20220304173014289" src="../assets/image-20220304173014289.png" /></p>
<p>从上图中我们可看出坐标x,y的范围在0-1000之间，且每一部分的分布都比较均匀，所以可以判断出目标框有可能会出现在图像的任意位置。</p>
<ul>
<li>标注框位置中心点坐标的分布</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 获取数据的中心点坐标</span>
    <span class="n">train_data_label</span><span class="p">[</span><span class="s1">&#39;cx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_data_label</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">train_data_label</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">train_data_label</span><span class="p">[</span><span class="s1">&#39;cy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_data_label</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">train_data_label</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="c1"># 绘制分布图像</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">train_data_label</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;cy&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">pmax</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="c1"># 设置轴描述</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;cx&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;cy&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>结果如下图所示：</p>
<p><img alt="image-20220304173621970" src="../assets/image-20220304173621970.png" /></p>
<p>从上图中我们可看出坐标cx,cy的范围在0-1000之间，且每一部分的分布都比较均匀，所以可以判断出目标框有可能会出现在图像的任意位置。</p>
<ul>
<li>标注框的宽高的分布</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 标注框宽高的分布</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">train_data_label</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">pmax</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="c1"># 轴描述</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>结果为：</p>
<p><img alt="image-20220304173813500" src="../assets/image-20220304173813500.png" /></p>
<p>从上图中我们可看出标砖框宽高的范围在0-1000之间，主要集中在0-400之间，比例集中在1：1，这可以作为anchor设置的依据，</p>
<ul>
<li>标注框面积的分布</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 标注框面积的分布：用来设置anchor的尺度</span>
    <span class="n">aeras</span> <span class="o">=</span> <span class="n">train_data_label</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">train_data_label</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;目标框最小面积为</span><span class="si">{}</span><span class="s2">最大面积为</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">aeras</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">aeras</span><span class="p">)))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">aeras</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>结果如下所示：</p>
<p><img alt="image-20220304174316257" src="../assets/image-20220304174316257.png" /></p>
<p>从图中可以看出，标注框的面积集中在0-5000以下，可以用来筛选异常的检测框。</p>
<h4 id="223">2.2.3 数据展示<a class="headerlink" href="#223" title="Permanent link">&para;</a></h4>
<p>该部分代码在文件：fasterRCNN_code/dataset_utils.py中。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 图片及标注框预览</span>
    <span class="c1"># 设置坐标轴的个数</span>
    <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
    <span class="c1"># 获取标注信息</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">train_data_label</span><span class="p">[</span><span class="s1">&#39;image_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">100</span><span class="p">:</span><span class="mi">100</span> <span class="o">+</span> <span class="n">num_rows</span> <span class="o">*</span> <span class="n">num_cols</span><span class="p">]</span>
    <span class="c1"># 读取图片</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">train_data_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">.jpg&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
    <span class="c1"># 图片显示</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">show_images</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">)</span>
    <span class="c1"># 显示标注框</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
        <span class="n">datas</span> <span class="o">=</span> <span class="n">train_data_label</span><span class="p">[</span><span class="n">train_data_label</span><span class="p">[</span><span class="s1">&#39;image_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="n">bboxes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datas</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
        <span class="n">show_bboxes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>在这里我们将标注框绘制在相应的图片上，结果如下图所示：</p>
<p><img alt="image-20220304174700934" src="../assets/image-20220304174700934.png" /></p>
<h2 id="3dataset">3.数据加载DataSet的构建<a class="headerlink" href="#3dataset" title="Permanent link">&para;</a></h2>
<p>在这里我们继承 <code>torch.utils.data.Dataset</code> 抽象类，实现<code>__init__</code> <code>__len__</code> <code>__getitem__</code> 。</p>
<p>其中：</p>
<ul>
<li><code>__init__</code>方法进行参数的初始化，包括</li>
<li><code>__len__</code>方法获取数量集中图片的数量</li>
<li>
<p><code>__getitem__</code> 获取数据：</p>
</li>
<li>
<p>image: 图像数据</p>
</li>
<li>target: 字典数据，包括模型训练时的目标值信息，介绍如下：<ul>
<li><code>boxes</code> : 表示标注框的左上角坐标和右下角坐标 <code>[x0, y0, x1, y1]</code>。</li>
<li><code>label</code> : 标志标注框的类别，在当前任务中只有小麦一个类别，所以所有标注框的类别标签值设为1</li>
</ul>
</li>
</ul>
<p>该部分代码在文件：fasterRCNN_code/dataset.py中，代码实现如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 数据读取类</span>
<span class="k">class</span> <span class="nc">Wheat</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="c1"># 初始化</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">image_dir</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param dataframe: 数据标注结果</span>
<span class="sd">        :param image_dir: 图像路径</span>
<span class="sd">        :param phase: 训练阶段train或预测阶段test</span>
<span class="sd">        :param transforms: 图像增强处理</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># 数据标注的CSV结果</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">dataframe</span>
        <span class="c1"># 图像路径</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span> <span class="o">=</span> <span class="n">image_dir</span>
        <span class="c1"># 阶段信息</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span>
        <span class="c1"># 图像增强方法</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span>
        <span class="c1"># 图像文件名称：去重之后的结果</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_id</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;image_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="c1"># 获取数据的数量</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_id</span><span class="p">)</span>

    <span class="c1"># 获取每一幅图片</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="c1"># 获取图像信息</span>
        <span class="n">image_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_id</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s1">.jpg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
        <span class="c1"># 训练阶段</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="c1"># 根据图像的名称获取对应的标注信息</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;image_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">image_id</span><span class="p">]</span>
            <span class="c1"># 获取目标框</span>
            <span class="n">boxes</span> <span class="o">=</span> <span class="n">records</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># 获取目标框的右下角坐标</span>
            <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="c1"># 每一框的类别为小麦，设为1（因为只有一个类别）</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">records</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="c1"># 设置目标值信息，目标值存放在target字典中：目标框的位置，目标类别值</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">target</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span>
            <span class="n">target</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
            <span class="c1"># 增强处理</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">:</span>
                <span class="c1"># 增强的内容包括：图像，框和类别</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
                    <span class="s1">&#39;bboxes&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">labels</span>
                <span class="p">}</span>
                <span class="c1"># 将sample字典中的key和value解包为key=value的方式传输到数据增强方法中</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">(</span><span class="o">**</span><span class="n">sample</span><span class="p">)</span>
                <span class="c1"># 获取增强后的图像</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
                <span class="c1"># 对图像中的标注框坐标进行拼接，并调整成n*4的维度,n表示图像的目标框的数量</span>
                <span class="n">target</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">]))))</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># 返回增强后的图像，目标值和对应的图像名称</span>
            <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">image_id</span>
        <span class="c1"># 预测阶段</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 预测阶段只需对图像进行处理，没有目标值</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">:</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image</span><span class="p">}</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">(</span><span class="o">**</span><span class="n">sample</span><span class="p">)</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image_id</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_transform</span><span class="p">():</span>
        <span class="c1"># 训练阶段图像增强进行翻转（注意框也会随之变换）和类型的转换</span>
        <span class="k">return</span> <span class="n">A</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">A</span><span class="o">.</span><span class="n">Flip</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="n">ToTensor</span><span class="p">()</span>
        <span class="p">],</span> <span class="n">bbox_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;pascal_voc&#39;</span><span class="p">,</span> <span class="s1">&#39;label_fields&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]})</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_test_transform</span><span class="p">():</span>
        <span class="c1"># 预测时只需要进行类型的转换</span>
        <span class="k">return</span> <span class="n">A</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">ToTensor</span><span class="p">()</span>
        <span class="p">])</span>
</code></pre></div>
<p>接下来我们以训练集数据为例，来看下输出的结果：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># 获取数据和标签信息</span>
    <span class="n">train_data_dir</span> <span class="o">=</span> <span class="s1">&#39;wheatData/train&#39;</span>
    <span class="n">train_data_label</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;wheatData/train_data.csv&#39;</span><span class="p">)</span>
    <span class="c1"># 实例化数据获取类</span>
    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">Wheat</span><span class="p">(</span><span class="n">train_data_label</span><span class="p">,</span><span class="n">train_data_dir</span><span class="p">)</span>
    <span class="c1"># 遍历图像进行显示</span>
    <span class="n">datas</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">)]</span>
    <span class="c1"># 获取图像数据（CHW-》HWC）</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">]</span>
    <span class="c1"># 图像展示</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">show_images</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># 标注框展示</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">image_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">datas</span><span class="p">):</span>
        <span class="n">show_bboxes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">target</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>输出结果如下所示：</p>
<p><img alt="image-20220304182033411" src="../assets/image-20220304182033411.png" /></p>
<h2 id="4">4.模型训练<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 模型构建<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<p>在这里我们构建fasterRCNN的模型的来进行麦穗检测，该部分代码在文件fasterRCNN_code/train.py中，详细介绍如下：</p>
<ul>
<li>首先我们利用torchvision创建Faster RCNN的预训练模型，如下所示：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建模型，使用torchvision中的fasterRCNN模型，使用预训练模型; 训练过程中不修改backbone部分的参数</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">detection</span><span class="o">.</span><span class="n">fasterrcnn_resnet50_fpn</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trainable_backbone_layers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;预训练模型的输出端</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span><span class="p">))</span>
</code></pre></div>
<p>输出结果为：</p>
<div class="highlight"><pre><span></span><code><span class="n">预训练模型的输出端FastRCNNPredictor</span><span class="p">(</span>
  <span class="p">(</span><span class="n">cls_score</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">91</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="p">(</span><span class="n">bbox_pred</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">364</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>从输出结果中可以看出，当前的预训练模型输出类别个数为90类并不适合我们当前的任务，所以我们需要对输出端进行修改。</p>
<ul>
<li>模型的修改，我们需要替换输出层，要获取输出层输入特征的大小，并将输出层的大小改为2：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 当前任务检测一类数据（小麦），fasterRcnn中需要设置为N+1(背景)，设置为2</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1"># 获取输出端的特征向量的维度</span>
<span class="n">in_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span><span class="o">.</span><span class="n">cls_score</span><span class="o">.</span><span class="n">in_features</span>
<span class="c1"># 设置输出端：</span>
<span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span> <span class="o">=</span> <span class="n">FastRCNNPredictor</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前任务的输出端</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span><span class="p">))</span>
</code></pre></div>
<p>输出结果为：</p>
<div class="highlight"><pre><span></span><code><span class="n">当前任务的输出端FastRCNNPredictor</span><span class="p">(</span>
  <span class="p">(</span><span class="n">cls_score</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="p">(</span><span class="n">bbox_pred</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>从输出结果中可以看出，修改后的模型输出类别个数为2类，适合我们当前的任务，所以我们使用该模型来处理当前的任务。</p>
<h3 id="42">4.2 训练参数设置<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<p>在训练过程中我们需要设置设备信息，优化器，轮次，批量大小等参数，该部分代码在文件fasterRCNN_code/train.py中，详细介绍如下：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 训练设备的设置，有GPU的使用GPU，否则使用CPU进行训练</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="c1"># 将模型写入到设备中</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="c1"># 获取所有要进行训练的参数，设置优化器</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">]</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">)</span>
<span class="c1"># 设置训练的轮次</span>
<span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c1"># 批次大小</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">4</span>
</code></pre></div>
<p>输出信息如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="n">设备信息</span><span class="err">：</span><span class="n">cpu</span>
<span class="n">优化器</span><span class="err">：</span><span class="n">SGD</span> <span class="p">(</span>
<span class="n">Parameter</span> <span class="n">Group</span> <span class="mi">0</span>
    <span class="n">dampening</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">lr</span><span class="p">:</span> <span class="mf">0.005</span>
    <span class="n">momentum</span><span class="p">:</span> <span class="mf">0.9</span>
    <span class="n">nesterov</span><span class="p">:</span> <span class="kc">False</span>
    <span class="n">weight_decay</span><span class="p">:</span> <span class="mf">0.0005</span>
<span class="p">)</span>
</code></pre></div>
<p>从输出信息中可以看出当前设备是CPU，优化器使用加动量的梯度下降算法。</p>
<h3 id="43">4.3 数据加载<a class="headerlink" href="#43" title="Permanent link">&para;</a></h3>
<p>在训练过程中我们需要按照批次的大小来获取数据送入网络中进行训练，创建DataLoader来获取数据，该部分代码在文件fasterRCNN_code/train.py中，详细介绍如下：在这里指明数据的为位置，创建Dataloader获取数据集。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 获取数据和标签信息</span>
<span class="n">train_data_dir</span> <span class="o">=</span> <span class="s1">&#39;wheatData/train&#39;</span>
<span class="n">train_data_label</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;wheatData/train_data.csv&#39;</span><span class="p">)</span>
<span class="c1"># 实例化数据获取类</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">Wheat</span><span class="p">(</span><span class="n">train_data_label</span><span class="p">,</span> <span class="n">train_data_dir</span><span class="p">,</span><span class="n">transforms</span><span class="o">=</span><span class="n">Wheat</span><span class="o">.</span><span class="n">get_transform</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">))</span>

<span class="c1"># 获取batch的数据，送入网络中进行训练</span>
<span class="n">train_data_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">train_dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span>
<span class="p">)</span>
</code></pre></div>
<p>接下来我们展示每个batch的数据，如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># batch数据的展示(每个batch中有batchsize个数据)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">img_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_data_loader</span><span class="p">):</span>
    <span class="c1"># 标注信息</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;标注信息&#39;</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
    <span class="c1"># 获取当前batch中的图像</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">imgs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)]</span>
    <span class="c1"># 图像展示</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">show_images</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># 标注框展示</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
        <span class="n">show_bboxes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">target</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">break</span>
</code></pre></div>
<p>结果如下：</p>
<p><img alt="image-20220307114404825" src="../assets/image-20220307114404825.png" /></p>
<p>每个batch是四张图片，标注信息如上图所示。</p>
<h3 id="44">4.4 模型训练<a class="headerlink" href="#44" title="Permanent link">&para;</a></h3>
<p>模型构建完成和数据加载进来后我们就可以进行模型训练，该部分代码在文件fasterRCNN_code/train.py中，详细介绍如下，整体流程：</p>
<ul>
<li>遍历每个轮次</li>
<li>遍历每个batch的图像</li>
<li>模型前向传播进行预测</li>
<li>损失计算</li>
<li>反向传播更新梯度即可</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 迭代次数</span>
<span class="n">itr</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># 存放训练损失</span>
<span class="n">total_train_loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># 损失值</span>
<span class="n">losses_value</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># 遍历每个轮次进行训练</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
    <span class="c1"># 计时</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># 训练模式</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">train_loss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># 进度条</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;let</span><span class="se">\&#39;</span><span class="s1">s train&#39;</span><span class="p">)</span>
    <span class="c1"># 遍历数据，获取图像，目标值和图像id</span>
    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">image_ids</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="c1"># 将图像写入设备中</span>
        <span class="n">images</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">)</span>
        <span class="c1"># 将目标值写入设备中：key：value</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">]</span>
        <span class="c1"># 将数据送入网络中进行训练，获取损失值</span>
        <span class="n">loss_dict</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">loss_dict</span><span class="p">)</span>
        <span class="c1"># 将损失求和</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">loss</span> <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">loss_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="c1"># 获取loss值</span>
        <span class="n">losses_value</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">train_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">losses_value</span><span class="p">)</span>
        <span class="c1"># 进行反向传播，更新参数</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="c1"># 日志信息</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch: </span><span class="si">{</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">, Batch: </span><span class="si">{</span><span class="n">itr</span><span class="si">}</span><span class="s2">, Loss: </span><span class="si">{</span><span class="n">losses_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># 迭代次数增1</span>
        <span class="n">itr</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># 获取当前轮次的损失</span>
    <span class="n">epoch_train_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
    <span class="c1"># 轮次损失写入到列表中</span>
    <span class="n">total_train_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_train_loss</span><span class="p">)</span>
</code></pre></div>
<p>训练过程如下：</p>
<div class="highlight"><pre><span></span><code><span class="n">Epoch</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Batch</span><span class="p">:</span> <span class="mi">675</span><span class="p">,</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">1.100306952323752</span><span class="p">:</span> <span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">675</span><span class="o">/</span><span class="mi">675</span> <span class="p">[</span><span class="mi">08</span><span class="p">:</span><span class="mi">26</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span>  <span class="mf">1.33</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">Epoch</span> <span class="n">Completed</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">Time</span><span class="p">:</span> <span class="mf">566.7130048274994</span><span class="p">,</span> <span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">1.05390335455138</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Batch</span><span class="p">:</span> <span class="mi">1350</span><span class="p">,</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.8195391336080114</span><span class="p">:</span> <span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">675</span><span class="o">/</span><span class="mi">675</span> <span class="p">[</span><span class="mi">08</span><span class="p">:</span><span class="mi">27</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span>  <span class="mf">1.33</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">Epoch</span> <span class="n">Completed</span><span class="p">:</span> <span class="mi">2</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">Time</span><span class="p">:</span> <span class="mf">569.5055477619171</span><span class="p">,</span> <span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.8958109236268262</span>
<span class="err">。。。</span>
</code></pre></div>
<p>我们训练过程中损失函数的变化曲线绘制出来：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 绘制整个训练过程中每个轮次的损失</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_train_loss</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="n">total_train_loss</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Train Loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>结果如下图所示：</p>
<p><img alt="image-20220307115524871" src="../assets/image-20220307115524871.png" /></p>
<h3 id="45">4.5 模型保存<a class="headerlink" href="#45" title="Permanent link">&para;</a></h3>
<p>我们训练完模型后，需要把模型参数保存下来，保存的代码在文件fasterRCNN_code/train.py中，如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 4.模型保存</span>
<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s1">&#39;fasterrcnn_resnet50_fpn.pth&#39;</span><span class="p">)</span>
</code></pre></div>
<p>模型参数保存完成后，我们就可以加载训练好的参数进行预测了。</p>
<h2 id="5">5.模型测试<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>在这里我们要加载要预测的图片数据，加载训练好的模型，并利用训练好的模型进行预测，该部分的代码在文件fasterRCNN_code/test.py中。</p>
<h3 id="51">5.1 数据和模型加载<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<p>在这里我们首先准备测试的数据，在加载训练好的模型，代码在在文件fasterRCNN_code/test.py中，具体实现如下：</p>
<ul>
<li>
<p>数据的加载，整体流程是：</p>
</li>
<li>
<p>设置要预测的图片的路径</p>
</li>
<li>实例化测试数据集的读取类</li>
<li>创建dataloader获取送入网络中的数据</li>
</ul>
<p>具体实现如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 设置测试数据集路径</span>
<span class="n">test_data_dir</span> <span class="o">=</span> <span class="s1">&#39;wheatData/test&#39;</span>
<span class="c1"># 加载数据</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;wheatData/submission.csv&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
<span class="c1"># 实例化数据读取类</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">Wheat</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_data_dir</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="n">Wheat</span><span class="o">.</span><span class="n">get_test_transform</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">))</span>
<span class="c1"># 设置batch_size</span>
<span class="n">batchsize</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1"># 加载测试集数据</span>
<span class="n">test_data_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="c1"># 测试数据</span>
    <span class="n">test_data</span><span class="p">,</span>
    <span class="c1"># 批次大小</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batchsize</span><span class="p">,</span>
    <span class="c1"># 测试集不需要打乱</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="c1"># 不满batch的数据依然要进行预测</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span>
<span class="p">)</span>
</code></pre></div>
<p>输出结果：</p>
<p>参数网络预测的图片的image_id如下所示：</p>
<p><img alt="image-20220322175115643" src="../assets/image-20220322175115643.png" /></p>
<p>测试图像的展示代码如下：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 测试集图片的展示</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">img_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_data_loader</span><span class="p">):</span>
    <span class="c1"># 获取当前batch中的图像</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">imgs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batchsize</span><span class="p">)]</span>
    <span class="c1"># 图像展示</span>
    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">break</span>
</code></pre></div>
<p>其中某幅图片展示效果如下所示：</p>
<p><img alt="image-20220307144011391" src="../assets/image-20220307144011391.png" /></p>
<ul>
<li>模型参数加载，流程是：</li>
<li>指定训练好的模型参数的路径</li>
<li>加载模型结构（与训练阶段是一样的），并加载模型参数</li>
<li>将模型设置为预测模式，并写入到设备中</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 指明模型参数的路径</span>
<span class="n">weight_dir</span> <span class="o">=</span> <span class="s1">&#39;weights/fasterrcnn_resnet50_fpn.pth&#39;</span>
<span class="c1"># 2.加载训练好的模型</span>
<span class="c1"># 设置设备信息</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="c1"># 构建fasterRCNN模型</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">detection</span><span class="o">.</span><span class="n">fasterrcnn_resnet50_fpn</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pretrained_backbone</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># 类别个数：N+1</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1"># 获取输出层输入特征向量的维度</span>
<span class="n">in_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span><span class="o">.</span><span class="n">cls_score</span><span class="o">.</span><span class="n">in_features</span>
<span class="c1"># 构建fasterRCNN的输出端</span>
<span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span> <span class="o">=</span> <span class="n">FastRCNNPredictor</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前任务的输出端</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span><span class="p">))</span>
<span class="c1"># 加载训练好的参数</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">weight_dir</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
<span class="c1"># 模型预测模式</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="c1"># 将模型写入到设备中</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div>
<p>在这里我们打印模型的输出端：</p>
<div class="highlight"><pre><span></span><code><span class="n">当前任务的输出端FastRCNNPredictor</span><span class="p">(</span>
  <span class="p">(</span><span class="n">cls_score</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="p">(</span><span class="n">bbox_pred</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>从这里可以看出我们的模型是进行麦穗检测的模型架构。</p>
<h3 id="52">5.2 模型预测<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<p>准备测试的数据和加载训练好的模型，我们就可以将数据送入网络中进行预测，代码在在文件fasterRCNN_code/test.py中，具体实现流程如下：</p>
<ul>
<li>设置预测的置信度阈值</li>
<li>遍历每个batch的图片进行预测</li>
<li>遍历预测结果，使用置信度阈值进行筛选</li>
</ul>
<p>具体实现如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 类别概率的阈值</span>
<span class="n">score_threshold</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="c1"># 存放预测结果</span>
<span class="n">image_outputs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># 遍历每个批次的测试数据</span>
<span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">image_ids</span> <span class="ow">in</span> <span class="n">test_data_loader</span><span class="p">:</span>
    <span class="c1"># 获取每一幅图片并写入到设备中</span>
    <span class="n">images</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">)</span>
    <span class="c1"># 模型预测返回结果</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="c1"># 遍历图像和预测结果</span>
    <span class="k">for</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_ids</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
        <span class="c1"># 框</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="c1"># 类别概率值</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="c1"># 使用预测进行筛选</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">&gt;=</span> <span class="n">score_threshold</span>
        <span class="c1"># 获取最终的检测框和类别概率值</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="c1"># 添加到列表中进行保存</span>
        <span class="n">image_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">image_id</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">))</span>
</code></pre></div>
<p>接下来我们将预测结果进行展示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 预测结果展示</span>
<span class="c1"># 获取测试集图片数据</span>
<span class="n">datas</span> <span class="o">=</span> <span class="p">[</span><span class="n">test_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_outputs</span><span class="p">))]</span>
<span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">]</span>
<span class="c1"># 图像展示</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">show_images</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_outputs</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># 预测框的展示</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">img_id</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">image_outputs</span><span class="p">):</span>
    <span class="n">show_bboxes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>展示结果如下所示：</p>
<p><img alt="image-20220304153849959" src="../assets/image-20220304153849959.png" /></p>
<p>上图展示了模型的预测结果，从图中可以观测出大部分的麦穗被我们检测出来了。到这里整个案例就给大家介绍完成了。</p>
<hr />
<p><strong>总结</strong></p>
<ul>
<li>了解麦穗检测的数据集的构成</li>
</ul>
<p>主要有训练集数据和测试集数据构成，训练集数据进行了标注。</p>
<ul>
<li>理解项目解决的全流程</li>
</ul>
<p>数据读取-》数据分析-》数据加载-》模型构建-》模型训练-》模型测试</p>
<ul>
<li>能够利用fasterRCNN网络模型进行训练和预测</li>
</ul>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="../02-Faster-RCNN/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 2.3 Faster-RCNN网络" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              2.3 Faster-RCNN网络
            </div>
          </div>
        </a>
      
      
        
        <a href="../04-yolo/" class="md-footer__link md-footer__link--next" aria-label="下一页: 2.5.yolo系列" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              2.5.yolo系列
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "search": "../../assets/javascripts/workers/search.01824240.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.a87c2adc.min.js"></script>
      
        <script src="../../js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>